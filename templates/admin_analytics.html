{% extends "layout.html" %}
{% block content %}
<h1>Analytics</h1>
<div class="dashboard-info">
  <div class="card">
    <h2>{{ user.username }}</h2>
    <p>{{ user.email }}</p>
    <p>{{ user.prefix }} {{ user.phone }}</p>
  </div>
</div>
<nav class="tab-nav">
  <a href="#" data-tab="overview" class="active">Overview</a>
    <a href="#" data-tab="revenue">Revenue & Fees</a>
    <a href="#" data-tab="orders">Orders & Operations</a>
    <a href="#" data-tab="products">Products / Menu</a>
    <a href="#" data-tab="clients">Customers & Credits</a>
    <a href="#" data-tab="finance">Finance</a>
    <a href="#" data-tab="refunds">Refunds</a>
    <a href="#" data-tab="exports">Exports</a>
</nav>
<div id="overview" class="tab-content active">
  <div class="dashboard-actions">
      <div class="card" title="Total number of orders in the selected period">
        <h3>Orders</h3><p>{{ stats.orders }}</p>
    </div>
      <div class="card" title="Total order value before taxes and fees">
        <h3>Gross GMV</h3><p>CHF {{ '%.2f'|format(stats.gmv_gross) }}</p>
    </div>
      <div class="card" title="Total order value after taxes and fees">
        <h3>Net GMV</h3><p>CHF {{ '%.2f'|format(stats.gmv_net) }}</p>
    </div>
      <div class="card" title="Average order value">
      <h3>AOV</h3><p>CHF {{ '%.2f'|format(stats.aov) }}</p>
    </div>
      <div class="card" title="Commission amount and percentage retained by SiplyGo">
        <h3>SiplyGo fees</h3><p>CHF {{ '%.2f'|format(stats.commission_amount) }} ({{ '%.1f'|format(stats.commission_pct) }}%)</p>
    </div>
      <div class="card" title="Amount due to the bar after fees and taxes">
        <h3>Net to bar</h3><p>CHF {{ '%.2f'|format(stats.payout_total) }}</p>
    </div>
      <div class="card" title="Total tips collected via the platform">
      <h3>Tips</h3><p>CHF {{ '%.2f'|format(stats.tips) }}</p>
    </div>
      <div class="card" title="Percentage of orders cancelled out of total">
        <h3>Cancellation rate</h3><p>{{ '%.1f'|format(stats.cancellation_rate) }}%</p>
    </div>
  </div>
  <canvas id="gmvChart"></canvas>
  <div class="dashboard-actions">
      <div class="card" title="Time slot with highest number of orders">
        <h4>Peak hour</h4><p>{{ stats.peak_hour }}</p>
    </div>
      <div class="card" title="Product category with highest revenue">
        <h4>Top category</h4><p>{{ stats.top_category }}</p>
    </div>
      <div class="card" title="Bar with highest sales volume">
        <h4>Top bar</h4><p>{{ stats.top_bar }}</p>
    </div>
  </div>
</div>
<div id="revenue" class="tab-content">
  <canvas id="revenueChart"></canvas>
  <table>
      <tr><th>Bar</th><th>GMV</th><th>VAT</th><th>Commission</th><th>Take rate</th><th>Net</th></tr>
    {% for r in stats.revenue_bars %}
    <tr>
      <td>{{ r.bar }}</td>
      <td>CHF {{ '%.2f'|format(r.gmv) }}</td>
      <td>CHF {{ '%.2f'|format(r.vat) }}</td>
      <td>CHF {{ '%.2f'|format(r.commission) }}</td>
      <td>{{ '%.1f'|format(r.take_rate) }}%</td>
      <td>CHF {{ '%.2f'|format(r.net) }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
  <div id="orders" class="tab-content">
    <canvas id="ordersChart"></canvas>
    <p>Total cancellations: {{ stats.cancelled_orders }}</p>
  </div>
<div id="products" class="tab-content">
    <table>
      <tr><th>Product</th><th>Quantity</th><th>Revenue</th></tr>
    {% for p in stats.top_products %}
    <tr>
      <td>{{ p.name }}</td>
      <td>{{ p.qty }}</td>
      <td>CHF {{ '%.2f'|format(p.revenue) }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
<div id="clients" class="tab-content">
  <div class="dashboard-actions">
      <div class="card" title="Customers who placed their first order">
        <h4>New</h4><p>{{ stats.new_customers }}</p>
    </div>
      <div class="card" title="Customers who placed more than one order">
        <h4>Returning</h4><p>{{ stats.returning_customers }}</p>
    </div>
  </div>
    <table>
      <tr><th>Customer</th><th># orders</th><th>Spend</th><th>Last purchase</th></tr>
    {% for c in stats.customers %}
    <tr>
      <td>{{ c.id }}</td>
      <td>{{ c.count }}</td>
      <td>CHF {{ '%.2f'|format(c.spend) }}</td>
      <td>{{ c.last }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
<div id="finance" class="tab-content">
    <table>
      <tr><th>Period</th><th>Amount</th><th>Status</th></tr>
    {% for p in stats.payouts %}
    <tr>
      <td>{{ p.start }} â€“ {{ p.end }}</td>
      <td>CHF {{ '%.2f'|format(p.amount) }}</td>
      <td>{{ p.status }}</td>
    </tr>
    {% endfor %}
  </table>
    <p>Total VAT: CHF {{ '%.2f'|format(stats.vat_total) }}</p>
</div>
  <div id="refunds" class="tab-content">
    <p>Total refunds: CHF {{ '%.2f'|format(stats.refund_total) }} ({{ stats.refund_count }} orders)</p>
  </div>
  <div id="exports" class="tab-content">
    <p>CSV exports and scheduled reports will be available soon.</p>
  </div>
<style>
.tab-nav a{margin-right:1rem;cursor:pointer;}
.tab-nav a.active{font-weight:bold;}
.tab-content{display:none;margin-top:1rem;}
.tab-content.active{display:block;}
</style>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ stats.daily_labels|tojson }};
const gmv = {{ stats.daily_gmv|tojson }};
const orders = {{ stats.daily_orders|tojson }};
const ctx = document.getElementById('gmvChart');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {label: 'GMV', data: gmv, borderColor: '#0d6efd', fill: false},
        {label: '# Orders', data: orders, borderColor: '#6c757d', fill: false, yAxisID: 'y1'}
    ]
  },
  options: {
    scales: {
      y: {beginAtZero: true},
      y1: {beginAtZero: true, position: 'right'}
    }
  }
});

const revData = {{ stats.revenue_bars|tojson }};
if (revData.length) {
  const revLabels = revData.map(r=>r.bar);
  const revGmv = revData.map(r=>r.gmv);
  const revComm = revData.map(r=>r.commission);
  const revNet = revData.map(r=>r.net);
  new Chart(document.getElementById('revenueChart'), {
    type: 'bar',
    data: {labels: revLabels, datasets: [
      {label: 'GMV', data: revGmv, backgroundColor: '#0d6efd'},
        {label: 'Commission', data: revComm, backgroundColor: '#dc3545'},
        {label: 'Net', data: revNet, backgroundColor: '#198754'}
    ]},
    options: {scales: {y: {beginAtZero: true}}}
  });
}

const hourLabels = {{ stats.hourly_labels|tojson }};
const hourOrders = {{ stats.hourly_orders|tojson }};
new Chart(document.getElementById('ordersChart'), {
  type: 'line',
  data: {labels: hourLabels, datasets: [
      {label: 'Orders/hour', data: hourOrders, borderColor: '#0d6efd', fill: false}
  ]},
  options: {scales: {y: {beginAtZero: true}}}
});

document.querySelectorAll('.tab-nav a').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.tab-nav a').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
    a.classList.add('active');
    document.getElementById(a.dataset.tab).classList.add('active');
  });
});
</script>
{% endblock %}
