{% extends "layout.html" %}
{% block content %}
<h1>{{ _('admin_analytics.title', default='Analytics') }}</h1>
<div class="dashboard-info">
  <div class="card">
    <h2>{{ user.username }}</h2>
    <p>{{ user.email }}</p>
    <p>{{ user.prefix }} {{ user.phone }}</p>
  </div>
</div>
<nav class="tab-nav">
  <a href="#" data-tab="overview" class="active">{{ _('admin_analytics.tabs.overview', default='Overview') }}</a>
    <a href="#" data-tab="revenue">{{ _('admin_analytics.tabs.revenue', default='Revenue & Fees')|safe }}</a>
    <a href="#" data-tab="orders">{{ _('admin_analytics.tabs.orders', default='Orders & Operations') }}</a>
    <a href="#" data-tab="products">{{ _('admin_analytics.tabs.products', default='Products / Menu') }}</a>
    <a href="#" data-tab="clients">{{ _('admin_analytics.tabs.clients', default='Customers & Credits') }}</a>
    <a href="#" data-tab="finance">{{ _('admin_analytics.tabs.finance', default='Finance') }}</a>
    <a href="#" data-tab="refunds">{{ _('admin_analytics.tabs.refunds', default='Refunds') }}</a>
    <a href="#" data-tab="exports">{{ _('admin_analytics.tabs.exports', default='Exports') }}</a>
</nav>
<div id="overview" class="tab-content active">
  <div class="dashboard-actions">
      <div class="card" title="{{ _('admin_analytics.overview.metrics.orders_tooltip', default='Total number of orders in the selected period') }}">
        <h3>{{ _('admin_analytics.overview.metrics.orders', default='Orders') }}</h3><p>{{ stats.orders }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.metrics.gmv_gross_tooltip', default='Total order value before taxes and fees') }}">
        <h3>{{ _('admin_analytics.overview.metrics.gmv_gross', default='Gross GMV') }}</h3><p>CHF {{ '%.2f'|format(stats.gmv_gross) }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.metrics.gmv_net_tooltip', default='Total order value after taxes and fees') }}">
        <h3>{{ _('admin_analytics.overview.metrics.gmv_net', default='Net GMV') }}</h3><p>CHF {{ '%.2f'|format(stats.gmv_net) }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.metrics.aov_tooltip', default='Average order value') }}">
      <h3>{{ _('admin_analytics.overview.metrics.aov', default='AOV') }}</h3><p>CHF {{ '%.2f'|format(stats.aov) }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.metrics.fees_tooltip', default='Commission amount and percentage retained by SiplyGo') }}">
        <h3>{{ _('admin_analytics.overview.metrics.fees', default='SiplyGo fees') }}</h3><p>CHF {{ '%.2f'|format(stats.commission_amount) }} ({{ '%.1f'|format(stats.commission_pct) }}%)</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.metrics.net_to_bar_tooltip', default='Amount due to the bar after fees and taxes') }}">
        <h3>{{ _('admin_analytics.overview.metrics.net_to_bar', default='Net to bar') }}</h3><p>CHF {{ '%.2f'|format(stats.payout_total) }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.metrics.tips_tooltip', default='Total tips collected via the platform') }}">
      <h3>{{ _('admin_analytics.overview.metrics.tips', default='Tips') }}</h3><p>CHF {{ '%.2f'|format(stats.tips) }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.metrics.cancel_rate_tooltip', default='Percentage of orders cancelled out of total') }}">
        <h3>{{ _('admin_analytics.overview.metrics.cancel_rate', default='Cancellation rate') }}</h3><p>{{ '%.1f'|format(stats.cancellation_rate) }}%</p>
    </div>
  </div>
  <canvas id="gmvChart"></canvas>
  <div class="dashboard-actions">
      <div class="card" title="{{ _('admin_analytics.overview.highlights.peak_hour_tooltip', default='Time slot with highest number of orders') }}">
        <h4>{{ _('admin_analytics.overview.highlights.peak_hour', default='Peak hour') }}</h4><p>{{ stats.peak_hour }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.highlights.top_category_tooltip', default='Product category with highest revenue') }}">
        <h4>{{ _('admin_analytics.overview.highlights.top_category', default='Top category') }}</h4><p>{{ stats.top_category }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.overview.highlights.top_bar_tooltip', default='Bar with highest sales volume') }}">
        <h4>{{ _('admin_analytics.overview.highlights.top_bar', default='Top bar') }}</h4><p>{{ stats.top_bar }}</p>
    </div>
  </div>
</div>
<div id="revenue" class="tab-content">
  <canvas id="revenueChart"></canvas>
  <table>
      <tr><th>{{ _('admin_analytics.revenue.headers.bar', default='Bar') }}</th><th>{{ _('admin_analytics.revenue.headers.gmv', default='GMV') }}</th><th>{{ _('admin_analytics.revenue.headers.vat', default='VAT') }}</th><th>{{ _('admin_analytics.revenue.headers.commission', default='Commission') }}</th><th>{{ _('admin_analytics.revenue.headers.take_rate', default='Take rate') }}</th><th>{{ _('admin_analytics.revenue.headers.net', default='Net') }}</th></tr>
    {% for r in stats.revenue_bars %}
    <tr>
      <td>{{ r.bar }}</td>
      <td>CHF {{ '%.2f'|format(r.gmv) }}</td>
      <td>CHF {{ '%.2f'|format(r.vat) }}</td>
      <td>CHF {{ '%.2f'|format(r.commission) }}</td>
      <td>{{ '%.1f'|format(r.take_rate) }}%</td>
      <td>CHF {{ '%.2f'|format(r.net) }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
  <div id="orders" class="tab-content">
    <canvas id="ordersChart"></canvas>
    <p>{{ _('admin_analytics.orders.total_cancellations', default='Total cancellations: {count}', count=stats.cancelled_orders) }}</p>
  </div>
<div id="products" class="tab-content">
    <table>
      <tr><th>{{ _('admin_analytics.products.headers.product', default='Product') }}</th><th>{{ _('admin_analytics.products.headers.quantity', default='Quantity') }}</th><th>{{ _('admin_analytics.products.headers.revenue', default='Revenue') }}</th></tr>
    {% for p in stats.top_products %}
    <tr>
      <td>{{ p.name }}</td>
      <td>{{ p.qty }}</td>
      <td>CHF {{ '%.2f'|format(p.revenue) }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
<div id="clients" class="tab-content">
  <div class="dashboard-actions">
      <div class="card" title="{{ _('admin_analytics.clients.metrics.new_tooltip', default='Customers who placed their first order') }}">
        <h4>{{ _('admin_analytics.clients.metrics.new', default='New') }}</h4><p>{{ stats.new_customers }}</p>
    </div>
      <div class="card" title="{{ _('admin_analytics.clients.metrics.returning_tooltip', default='Customers who placed more than one order') }}">
        <h4>{{ _('admin_analytics.clients.metrics.returning', default='Returning') }}</h4><p>{{ stats.returning_customers }}</p>
    </div>
  </div>
    <table>
      <tr><th>{{ _('admin_analytics.clients.headers.customer', default='Customer') }}</th><th>{{ _('admin_analytics.clients.headers.orders', default='# orders') }}</th><th>{{ _('admin_analytics.clients.headers.spend', default='Spend') }}</th><th>{{ _('admin_analytics.clients.headers.last_purchase', default='Last purchase') }}</th></tr>
    {% for c in stats.customers %}
    <tr>
      <td>{{ c.id }}</td>
      <td>{{ c.count }}</td>
      <td>CHF {{ '%.2f'|format(c.spend) }}</td>
      <td>{{ c.last }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
<div id="finance" class="tab-content">
    <table>
      <tr><th>{{ _('admin_analytics.finance.headers.period', default='Period') }}</th><th>{{ _('admin_analytics.finance.headers.amount', default='Amount') }}</th><th>{{ _('admin_analytics.finance.headers.status', default='Status') }}</th></tr>
    {% for p in stats.payouts %}
    <tr>
      <td>{{ p.start }} â€“ {{ p.end }}</td>
      <td>CHF {{ '%.2f'|format(p.amount) }}</td>
      <td>{{ p.status }}</td>
    </tr>
    {% endfor %}
  </table>
    <p>{{ _('admin_analytics.finance.total_vat', default='Total VAT: CHF {amount}', amount='%.2f'|format(stats.vat_total)) }}</p>
</div>
  <div id="refunds" class="tab-content">
    <p>{{ _('admin_analytics.refunds.total', default='Total refunds: CHF {amount} ({count} orders)', amount='%.2f'|format(stats.refund_total), count=stats.refund_count) }}</p>
  </div>
  <div id="exports" class="tab-content">
    <p>{{ _('admin_analytics.exports.message', default='CSV exports and scheduled reports will be available soon.') }}</p>
  </div>
<style>
.tab-nav a{margin-right:1rem;cursor:pointer;}
.tab-nav a.active{font-weight:bold;}
.tab-content{display:none;margin-top:1rem;}
.tab-content.active{display:block;}
</style>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% set chart_labels = {
  'gmv': _('admin_analytics.charts.gmv', default='GMV'),
  'orders': _('admin_analytics.charts.orders', default='# Orders'),
  'commission': _('admin_analytics.charts.commission', default='Commission'),
  'net': _('admin_analytics.charts.net', default='Net'),
  'orders_per_hour': _('admin_analytics.charts.orders_per_hour', default='Orders/hour')
} %}
<script>
const labels = {{ stats.daily_labels|tojson }};
const gmv = {{ stats.daily_gmv|tojson }};
const orders = {{ stats.daily_orders|tojson }};
const ctx = document.getElementById('gmvChart');
const chartLabels = {{ chart_labels|tojson }};
new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {label: chartLabels.gmv, data: gmv, borderColor: '#0d6efd', fill: false},
        {label: chartLabels.orders, data: orders, borderColor: '#6c757d', fill: false, yAxisID: 'y1'}
    ]
  },
  options: {
    scales: {
      y: {beginAtZero: true},
      y1: {beginAtZero: true, position: 'right'}
    }
  }
});

const revData = {{ stats.revenue_bars|tojson }};
if (revData.length) {
  const revLabels = revData.map(r=>r.bar);
  const revGmv = revData.map(r=>r.gmv);
  const revComm = revData.map(r=>r.commission);
  const revNet = revData.map(r=>r.net);
  new Chart(document.getElementById('revenueChart'), {
    type: 'bar',
    data: {labels: revLabels, datasets: [
      {label: chartLabels.gmv, data: revGmv, backgroundColor: '#0d6efd'},
        {label: chartLabels.commission, data: revComm, backgroundColor: '#dc3545'},
        {label: chartLabels.net, data: revNet, backgroundColor: '#198754'}
    ]},
    options: {scales: {y: {beginAtZero: true}}}
  });
}

const hourLabels = {{ stats.hourly_labels|tojson }};
const hourOrders = {{ stats.hourly_orders|tojson }};
new Chart(document.getElementById('ordersChart'), {
  type: 'line',
  data: {labels: hourLabels, datasets: [
      {label: chartLabels.orders_per_hour, data: hourOrders, borderColor: '#0d6efd', fill: false}
  ]},
  options: {scales: {y: {beginAtZero: true}}}
});

document.querySelectorAll('.tab-nav a').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.tab-nav a').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
    a.classList.add('active');
    document.getElementById(a.dataset.tab).classList.add('active');
  });
});
</script>
{% endblock %}
