{% extends "layout.html" %}
{% block content %}
{% set back_year = closing.closed_at.year %}
{% set back_month = closing.closed_at.month %}
{% set back_label = closing.closed_at.strftime('%B %Y') %}
<a class="back-link" href="/dashboard/bar/{{ bar.id }}/orders/history/{{ back_year }}/{{ back_month }}">
  <i class="bi bi-chevron-left" aria-hidden="true"></i>
  {{ _('bar_admin_history.back_to_month', month=back_label, default='Back to {month}') }}
</a>
<h1>{{ _('bar_admin_history.orders_title', bar=bar.name, date=closing.closed_at|format_time, default='{bar} - Orders for {date}') }}</h1>
<div class="revenue-card rc">
  <div class="rc-header">
    <h3 class="rc-title">{{ closing.closed_at|format_time }}</h3>
  </div>

  <div class="rc-kpis">
    <div class="rc-kpi">
      <span class="label">{{ _('bar_admin_history.metrics.total_collected', default='Total collected') }}</span>
      <span class="value">CHF {{ "%.2f"|format(closing.total_revenue) }}</span>
    </div>
    <div class="rc-kpi">
      <span class="label">{{ _('bar_admin_history.metrics.total_earned', default='Total earned') }}</span>
      <span class="value">CHF {{ "%.2f"|format(closing.total_earned) }}</span>
    </div>
    <div class="rc-kpi">
      <span class="label">{{ _('bar_admin_history.metrics.commission', default='Siplygo commission (5%)') }}</span>
      <span class="value rc-negative">CHF {{ "%.2f"|format(closing.siplygo_commission) }}</span>
    </div>
    <div class="rc-kpi rc-emph">
      <span class="label">{{ _('bar_admin_history.metrics.payout', default='Amount to pay to bar') }}</span>
      <span class="value">CHF {{ "%.2f"|format(bar_payout) }}</span>
    </div>
  </div>

  {% if payment_totals %}
  <div class="rc-breakdown">
    <h4 class="rc-subtitle">{{ _('bar_admin_history.breakdown.title', default='Payment breakdown:') }}</h4>
    <ul class="rc-list">
      {% for method, amount in payment_totals.items() %}
      <li><span class="item">{{ method }}</span><span class="amount">CHF {{ '%.2f'|format(amount) }}</span></li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>
<div class="order-list">
  {% for order in orders %}
  <article class="order-card card card--{{ order.status|lower }}" role="article" aria-labelledby="order-{{ order.id }}-title" data-status="{{ order.status }}">
    <header class="order-card__header">
      {% set order_code = order.public_order_code or ('#' ~ order.id) %}
      {% set status_label = order.status|replace('_', ' ')|title %}
      <h3 id="order-{{ order.id }}-title">{{ _('order_history.card.title', code=order_code, default='Order {code}') }}</h3>
      <span class="order-status chip status status-{{ order.status|lower }}" aria-label="{{ _('order_history.card.status_aria', status=status_label, default='Order status: {status}') }}">{{ _('order_history.card.status_label', status=status_label, default=status_label) }}</span>
    </header>
    <div class="order-card__divider"></div>
    <section class="order-card__meta">
      <dl class="order-kv">
        <div><dt>{{ _('order_history.card.fields.total', default='Total') }}</dt><dd class="num nowrap">CHF {{ "%.2f"|format(order.total) }}</dd></div>
        <div><dt>{{ _('order_history.card.fields.placed', default='Placed') }}</dt><dd class="num nowrap">{{ order.created_at|format_time }}</dd></div>

        <div><dt>{{ _('order_history.card.fields.customer', default='Customer') }}</dt><dd>{{ order.customer_name or _('order_history.card.unknown_customer', default='Unknown') }} <a href="tel:{{ (order.customer_prefix or '')|replace(' ', '') }}{{ (order.customer_phone or '')|replace(' ', '') }}">({{ order.customer_prefix or '' }} {{ order.customer_phone or '' }})</a></dd></div>

        <div><dt>{{ _('order_history.card.fields.table', default='Table') }}</dt><dd>{{ order.table_name or '' }}</dd></div>
        <div><dt>{{ _('order_history.card.fields.payment', default='Payment') }}</dt><dd>{{ order.payment_method.replace('_', ' ')|title if order.payment_method else '' }}</dd></div>

        {% if order.ready_at %}
        {% set prep_minutes = ((order.ready_at - order.created_at).total_seconds() // 60)|int %}
        <div><dt>{{ _('order_history.card.fields.prep_time', default='Prep time') }}</dt><dd class="num">{{ _('order_history.card.prep_minutes', minutes=prep_minutes, default='{minutes} min') }}</dd></div>
        {% endif %}
      </dl>
    </section>
    <div class="order-card__divider"></div>
    <section class="order-card__items">
      <ul class="order-items">
        {% for item in order.items %}
        <li><span class="qty">{{ item.qty }}Ã—</span><span class="name">{{ item.menu_item_name or _('order_history.card.unknown_item', default='Unknown item') }}</span></li>
        {% endfor %}
      </ul>
    </section>
  </article>
  {% else %}
  <p>{{ _('bar_admin_history.empty.orders', default='No orders.') }}</p>
  {% endfor %}
</div>
{% endblock %}
