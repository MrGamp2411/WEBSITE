{% extends "layout.html" %}
{% block content %}
<h1>Edit Bar</h1>
codex/fix-commit-conflicts-and-add-google-api-key-xxx1h4
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<div id="map" style="height:400px;"></div>

<label for="placeSearch">Search Google Maps
  <input id="placeSearch" type="text" placeholder="Type bar name">
</label>
 main
<form class="form" method="get">
  <label for="name">Name
    <input id="name" name="name" value="{{ bar.name }}">
  </label>
  <label for="address">Address
    <input id="address" name="address" value="{{ bar.address }}">
  </label>
  <label for="city">City
    <input id="city" name="city" value="{{ bar.city }}">
  </label>
  <label for="state">State
    <input id="state" name="state" value="{{ bar.state }}">
  </label>
  <input id="latitude" name="latitude" type="hidden" value="{{ bar.latitude }}">
  <input id="longitude" name="longitude" type="hidden" value="{{ bar.longitude }}">
  <button class="btn btn--primary" type="submit">Save</button>
</form>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
 codex/fix-commit-conflicts-and-add-google-api-key-xxx1h4
  const initialLat = {{ bar.latitude }};
  const initialLng = {{ bar.longitude }};
  const map = L.map('map').setView([initialLat, initialLng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);
  const marker = L.marker([initialLat, initialLng], {draggable:true}).addTo(map);
  function updateInputs(e) {
    const pos = e.target.getLatLng();
    document.getElementById('latitude').value = pos.lat.toFixed(6);
    document.getElementById('longitude').value = pos.lng.toFixed(6);

  let autocomplete;
  function initAutocomplete() {
    const input = document.getElementById('placeSearch');
    if (!input) return;
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });
    autocomplete = new google.maps.places.Autocomplete(input, {
      types: ['establishment'],
      fields: ['address_components', 'geometry', 'name']
    });
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;
      document.getElementById('name').value = place.name || '';
      // Parse address components so street, city and state are populated separately
      let street = '', city = '', state = '';
      if (place.address_components) {
        for (const comp of place.address_components) {
          const types = comp.types;
          if (types.includes('street_number')) street = comp.long_name + (street ? ' ' + street : '');
          if (types.includes('route')) street = street ? street + ' ' + comp.long_name : comp.long_name;
          if (types.includes('locality')) city = comp.long_name;
          if (types.includes('administrative_area_level_1')) state = comp.short_name;
        }
      }
      document.getElementById('address').value = street || place.formatted_address || '';
      document.getElementById('city').value = city;
      document.getElementById('state').value = state;
      document.getElementById('latitude').value = place.geometry.location.lat().toFixed(6);
      document.getElementById('longitude').value = place.geometry.location.lng().toFixed(6);
    });
 main
  }
  marker.on('dragend', updateInputs);
  updateInputs({target: marker});
</script>
{% endblock %}

