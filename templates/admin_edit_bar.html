{% extends "layout.html" %}
{% block page_styles %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="/static/css/pages/admin-edit-bar.css">
{% endblock %}
{% block content %}
<section class="editbar">
  <a class="back-link" href="{{ '/dashboard' if user and user.is_bar_admin else '/admin/bars/edit/' ~ bar.id }}"><i class="bi bi-chevron-left" aria-hidden="true"></i> {{ _('admin_edit_bar.back', default='Back to bar settings') }}</a>
  <h1>{{ _('admin_edit_bar.title', default='Edit Bar') }}</h1>
  {% if error %}<p class="error">{{ error }}</p>{% endif %}

  <div class="card map-card">
    <div id="map" data-initial-lat="{{ bar.latitude }}" data-initial-lng="{{ bar.longitude }}"></div>
  </div>

  <form method="post" action="/admin/bars/edit/{{ bar.id }}/info" enctype="multipart/form-data" class="editbar-form">
    <div class="grid-2">

      <div class="card form-card">
        <h2 class="card-title"><i class="bi bi-geo-alt"></i> {{ _('admin_edit_bar.cards.details.title', default='Details') }}</h2>

        <div class="field-group">
          <label for="name">{{ _('admin_edit_bar.fields.name', default='Name') }}</label>
          <input id="name" name="name" class="input-pill" value="{{ bar.name }}">
        </div>

        <div class="field-group">
          <label for="address">{{ _('admin_edit_bar.fields.address', default='Address') }}</label>
          <input id="address" name="address" class="input-pill" value="{{ bar.address }}">
        </div>

        <div class="field-row">
          <div class="field-group">
              <label for="city">{{ _('admin_edit_bar.fields.city', default='City') }}</label>
              <input id="city" name="city" class="input-pill" value="{{ bar.city }}">
          </div>
          <div class="field-group">
              <label for="state">{{ _('admin_edit_bar.fields.state', default='Canton') }}</label>
              <input id="state" name="state" class="input-pill" value="{{ bar.state }}">
          </div>
        </div>

        <div class="field-group description-field">
          <label>{{ _('admin_edit_bar.fields.description', default='Description') }}</label>
          <p class="description-preview">{{ bar_description(bar) or _('admin_edit_bar.description.none', default='No description yet') }}</p>
          <a class="btn btn--secondary" href="/admin/bars/edit/{{ bar.id }}/description">{{ _('admin_edit_bar.actions.edit_description', default='Edit description') }}</a>
          <small class="help">{{ _('admin_edit_bar.help.description', default='Short, clear description. Links will be ignored.') }}</small>
        </div>

        <div class="field-group">
          <label>{{ _('admin_edit_bar.fields.categories', default='Categories') }}</label>
          <div id="categoriesChips" class="chips-grid" aria-describedby="catHelp"></div>
          <div class="chips-meta">
            {% set max_categories = 5 %}
            {% set selected_count = selected_categories|length if selected_categories else 0 %}
            <small
              id="catCount"
              class="count"
              data-template="{{ _('admin_edit_bar.categories.count', default='{selected}/{max} selected') }}"
              data-max="{{ max_categories }}"
            >
              {{ _('admin_edit_bar.categories.count', default='{selected}/{max} selected', selected=selected_count, max=max_categories) }}
            </small>
            <small id="catHelp">{{ _('admin_edit_bar.help.categories', default='Click to select/deselect. Selected items are highlighted.') }}</small>
          </div>
          <select id="categoriesNative" name="categories" multiple hidden>
            {% for c in bar_categories %}
              <option value="{{ c }}" {% if c in selected_categories %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="card form-card">
        <h2 class="card-title"><i class="bi bi-card-image"></i> {{ _('admin_edit_bar.cards.media.title', default='Media &amp; Hours')|safe }}</h2>

        {% if bar.photo_url %}
        <div class="field-group">
          <img src="{{ bar.photo_url }}" alt="{{ _('admin_edit_bar.media.photo_alt', bar=bar.name, default='{bar} photo') }}" style="max-width:200px;"/>
        </div>
        {% endif %}

        <div class="field-group">
          <label for="photo">{{ _('admin_edit_bar.fields.photo', default='Photo') }}</label>
          <input id="photo" name="photo" type="file">
        </div>

        {% if user.is_super_admin %}
        <div class="field-group">
          <label for="rating">{{ _('admin_edit_bar.fields.rating', default='Rating') }}</label>
          <input id="rating" name="rating" class="input-pill" type="number" min="0" max="5" step="0.1" value="{{ bar.rating or 0 }}">
        </div>
        {% endif %}

        <div class="field-group">
          <label class="switch-label">
            <input id="manual_closed" name="manual_closed" type="checkbox" {% if bar.manual_closed %}checked{% endif %}> {{ _('admin_edit_bar.fields.manual_closed', default='Close bar manually') }}
          </label>
        </div>

        <div class="field-group hours-table-wrap">
          {% set days = [
            _('admin_edit_bar.days.monday', default='Monday'),
            _('admin_edit_bar.days.tuesday', default='Tuesday'),
            _('admin_edit_bar.days.wednesday', default='Wednesday'),
            _('admin_edit_bar.days.thursday', default='Thursday'),
            _('admin_edit_bar.days.friday', default='Friday'),
            _('admin_edit_bar.days.saturday', default='Saturday'),
            _('admin_edit_bar.days.sunday', default='Sunday')
          ] %}
          <table class="hours-table">
            <thead>
              <tr>
                <th>{{ _('admin_edit_bar.hours.day', default='Day') }}</th>
                <th>{{ _('admin_edit_bar.hours.open', default='Open') }}</th>
                <th>{{ _('admin_edit_bar.hours.close', default='Close') }}</th>
              </tr>
            </thead>
            <tbody>
            {% for day in days %}
              {% set idx = loop.index0 %}
              {% set h = hours.get(idx|string) if hours else None %}
              <tr>
                <td>{{ day }}</td>
                <td><input type="time" name="open_{{ idx }}" value="{{ h.open if h }}"></td>
                <td><input type="time" name="close_{{ idx }}" value="{{ h.close if h }}"></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <input id="latitude" name="latitude" type="hidden" value="{{ bar.latitude }}">
    <input id="longitude" name="longitude" type="hidden" value="{{ bar.longitude }}">
    <input type="hidden" name="promo_label" value="">
    <input type="hidden" name="tags" value="">

    <div class="form-actions save-inline">
      <button type="submit" class="btn btn--primary">{{ _('admin_edit_bar.actions.save', default='Save') }}</button>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/js/admin-edit-bar.js" defer></script>
{% endblock %}
