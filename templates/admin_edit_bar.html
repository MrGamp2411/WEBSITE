{% extends "layout.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<section class="editbar">
  <a class="back-link" href="/admin/bars/edit/{{ bar.id }}"><i class="bi bi-chevron-left" aria-hidden="true"></i> {{ _('admin_edit_bar.back', default='Back to bar settings') }}</a>
  <h1>{{ _('admin_edit_bar.title', default='Edit Bar') }}</h1>
  {% if error %}<p class="error">{{ error }}</p>{% endif %}

  <div class="card map-card">
    <div id="map" style="height:400px;"></div>
  </div>

  <form method="post" action="/admin/bars/edit/{{ bar.id }}/info" enctype="multipart/form-data" class="editbar-form">
    <div class="grid-2">

      <div class="card form-card">
        <h2 class="card-title"><i class="bi bi-geo-alt"></i> {{ _('admin_edit_bar.cards.details.title', default='Details') }}</h2>

        <div class="field-group">
          <label for="name">{{ _('admin_edit_bar.fields.name', default='Name') }}</label>
          <input id="name" name="name" class="input-pill" value="{{ bar.name }}">
        </div>

        <div class="field-group">
          <label for="address">{{ _('admin_edit_bar.fields.address', default='Address') }}</label>
          <input id="address" name="address" class="input-pill" value="{{ bar.address }}">
        </div>

        <div class="field-row">
          <div class="field-group">
              <label for="city">{{ _('admin_edit_bar.fields.city', default='City') }}</label>
              <input id="city" name="city" class="input-pill" value="{{ bar.city }}">
          </div>
          <div class="field-group">
              <label for="state">{{ _('admin_edit_bar.fields.state', default='Canton') }}</label>
              <input id="state" name="state" class="input-pill" value="{{ bar.state }}">
          </div>
        </div>

        <div class="field-group description-field">
          <label>{{ _('admin_edit_bar.fields.description', default='Description') }}</label>
          <p class="description-preview">{{ bar_description(bar) or _('admin_edit_bar.description.none', default='No description yet') }}</p>
          <a class="btn btn--secondary" href="/admin/bars/edit/{{ bar.id }}/description">{{ _('admin_edit_bar.actions.edit_description', default='Edit description') }}</a>
          <small class="help">{{ _('admin_edit_bar.help.description', default='Short, clear description. Links will be ignored.') }}</small>
        </div>

        <div class="field-group">
          <label>{{ _('admin_edit_bar.fields.categories', default='Categories') }}</label>
          <div id="categoriesChips" class="chips-grid" aria-describedby="catHelp"></div>
          <div class="chips-meta">
            {% set max_categories = 5 %}
            {% set selected_count = selected_categories|length if selected_categories else 0 %}
            <small
              id="catCount"
              class="count"
              data-template="{{ _('admin_edit_bar.categories.count', default='{selected}/{max} selected') }}"
              data-max="{{ max_categories }}"
            >
              {{ _('admin_edit_bar.categories.count', default='{selected}/{max} selected', selected=selected_count, max=max_categories) }}
            </small>
            <small id="catHelp">{{ _('admin_edit_bar.help.categories', default='Click to select/deselect. Selected items are highlighted.') }}</small>
          </div>
          <select id="categoriesNative" name="categories" multiple hidden>
            {% for c in bar_categories %}
              <option value="{{ c }}" {% if c in selected_categories %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="card form-card">
        <h2 class="card-title"><i class="bi bi-card-image"></i> {{ _('admin_edit_bar.cards.media.title', default='Media &amp; Hours')|safe }}</h2>

        {% if bar.photo_url %}
        <div class="field-group">
          <img src="{{ bar.photo_url }}" alt="{{ _('admin_edit_bar.media.photo_alt', bar=bar.name, default='{bar} photo') }}" style="max-width:200px;"/>
        </div>
        {% endif %}

        <div class="field-group">
          <label for="photo">{{ _('admin_edit_bar.fields.photo', default='Photo') }}</label>
          <input id="photo" name="photo" type="file">
        </div>

        {% if user.is_super_admin %}
        <div class="field-group">
          <label for="rating">{{ _('admin_edit_bar.fields.rating', default='Rating') }}</label>
          <input id="rating" name="rating" class="input-pill" type="number" min="0" max="5" step="0.1" value="{{ bar.rating or 0 }}">
        </div>
        {% endif %}

        <div class="field-group">
          <label class="switch-label">
            <input id="manual_closed" name="manual_closed" type="checkbox" {% if bar.manual_closed %}checked{% endif %}> {{ _('admin_edit_bar.fields.manual_closed', default='Close bar manually') }}
          </label>
        </div>

        <div class="field-group hours-table-wrap">
          {% set days = [
            _('admin_edit_bar.days.monday', default='Monday'),
            _('admin_edit_bar.days.tuesday', default='Tuesday'),
            _('admin_edit_bar.days.wednesday', default='Wednesday'),
            _('admin_edit_bar.days.thursday', default='Thursday'),
            _('admin_edit_bar.days.friday', default='Friday'),
            _('admin_edit_bar.days.saturday', default='Saturday'),
            _('admin_edit_bar.days.sunday', default='Sunday')
          ] %}
          <table class="hours-table">
            <thead>
              <tr>
                <th>{{ _('admin_edit_bar.hours.day', default='Day') }}</th>
                <th>{{ _('admin_edit_bar.hours.open', default='Open') }}</th>
                <th>{{ _('admin_edit_bar.hours.close', default='Close') }}</th>
              </tr>
            </thead>
            <tbody>
            {% for day in days %}
              {% set idx = loop.index0 %}
              {% set h = hours.get(idx|string) if hours else None %}
              <tr>
                <td>{{ day }}</td>
                <td><input type="time" name="open_{{ idx }}" value="{{ h.open if h }}"></td>
                <td><input type="time" name="close_{{ idx }}" value="{{ h.close if h }}"></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <input id="latitude" name="latitude" type="hidden" value="{{ bar.latitude }}">
    <input id="longitude" name="longitude" type="hidden" value="{{ bar.longitude }}">
    <input type="hidden" name="promo_label" value="">
    <input type="hidden" name="tags" value="">

    <div class="form-actions save-inline">
      <button type="submit" class="btn btn--primary">{{ _('admin_edit_bar.actions.save', default='Save') }}</button>
    </div>
  </form>
</section>
<style>
.description-field .description-preview{
  margin:0 0 12px;
  padding:12px 16px;
  border-radius:var(--radius-xl,16px);
  background:var(--surface-strong,#f3f4f6);
  font-size:0.95rem;
  line-height:1.5;
}
.description-field .description-preview:empty::before{
  content:"";
}
</style>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const initialLat = {{ bar.latitude }};
  const initialLng = {{ bar.longitude }};
  const map = L.map('map').setView([initialLat, initialLng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);
  const marker = L.marker([initialLat, initialLng], {draggable:true}).addTo(map);
  function updateInputs(e) {
    const pos = e.target.getLatLng();
    document.getElementById('latitude').value = pos.lat.toFixed(6);
    document.getElementById('longitude').value = pos.lng.toFixed(6);
  }
  marker.on('dragend', updateInputs);
  updateInputs({target: marker});
</script>
<script>
(function(){
  // --- Categories max 5 ---
  const select = document.getElementById('categoriesNative');
  const mount  = document.getElementById('categoriesChips');
  const countEl= document.getElementById('catCount');
  const countTemplate = countEl?.dataset.template || '{selected}/{max}';
  const countMax = Number(countEl?.dataset.max || 5);
  if(select && mount){
    const MAX = countMax || 5;
    const all = Array.from(select.options).map(o=>({ value:o.value, label:o.text, selected:o.selected }));
    const selectedCount = ()=> all.filter(i=>i.selected).length;

    function syncSelect(){
      all.forEach(i=>{
        const opt = Array.from(select.options).find(o=>o.value===i.value);
        if(opt) opt.selected = i.selected;
      });
    }
    function render(){
      mount.innerHTML = '';
      const cnt = selectedCount();
      if(countEl) countEl.textContent = countTemplate.replace('{selected}', cnt).replace('{max}', MAX);
      const limitReached = cnt >= MAX;

      all.forEach(item=>{
        const b = document.createElement('button');
        b.type='button';
        b.className='chip-btn';
        b.setAttribute('aria-pressed', item.selected ? 'true' : 'false');
        b.textContent = item.label;

        // disabilita i NON selezionati quando raggiunto il limite
        if(limitReached && !item.selected){ b.disabled = true; }

        b.addEventListener('click', ()=>{
          if(!item.selected && selectedCount() >= MAX) return; // hard stop
          item.selected = !item.selected;
          syncSelect();
          render();
        });

        b.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); b.click(); }
        });

        mount.appendChild(b);
      });
    }
    render();
  }

  // --- Close bar manually: dis/abilita gli input time ---
  const closeCb = document.getElementById('manual_closed');
  const hoursWrap = document.querySelector('.hours-table');
  function applyHoursDisabled(){
    if(!hoursWrap || !closeCb) return;
    const disabled = closeCb.checked;
    hoursWrap.classList.toggle('hours-disabled', disabled);
    hoursWrap.querySelectorAll('input[type="time"]').forEach(el=>{ el.disabled = disabled; });
  }
  if(closeCb){
    applyHoursDisabled();
    closeCb.addEventListener('change', applyHoursDisabled);
  }
})();
</script>
{% endblock %}

