{% extends "layout.html" %}
{% block content %}
<div class="auth-card">
  <h1>{{ _('topup.title', default='Top Up Credit') }}</h1>
  <form id="topupForm">
    <label for="amount">{{ _('topup.form.amount_label', default='Amount') }}
      <input id="amount" name="amount" type="number" min="10" step="0.05" required inputmode="decimal">
    </label>
    <div class="preset-buttons">
      <button type="button" class="btn" data-amount="10">10 CHF</button>
      <button type="button" class="btn" data-amount="20">20 CHF</button>
      <button type="button" class="btn" data-amount="50">50 CHF</button>
    </div>
    <button class="btn btn--primary" type="submit">{{ _('topup.form.submit', default='Top up with card') }}</button>
  </form>
</div>
<script>
  const amountInput = document.getElementById('amount');
  document.querySelectorAll('button[data-amount]').forEach(btn => {
    btn.addEventListener('click', () => {
      amountInput.value = btn.dataset.amount;
    });
  });
  const form = document.getElementById('topupForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  const invalidAmountMessage = {{ _('topup.alerts.invalid_amount', default='Invalid amount')|tojson }};
  const errorMessage = {{ _('topup.alerts.failed', default='Unable to start top-up')|tojson }};
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (submitBtn.disabled) return;
    const amount = parseFloat(amountInput.value);
    if (!Number.isFinite(amount) || amount < 10) {
      alert(invalidAmountMessage);
      return;
    }
    submitBtn.disabled = true;
    submitBtn.style.display = 'none';
    try {
      const resp = await fetch('/api/topup/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount })
      });
      if (resp.ok) {
        const data = await resp.json();
        if (data.paymentPageUrl) {
          window.location.replace(data.paymentPageUrl);
          return;
        }
      }
      alert(errorMessage);
      submitBtn.disabled = false;
      submitBtn.style.display = '';
    } catch {
      alert(errorMessage);
      submitBtn.disabled = false;
      submitBtn.style.display = '';
    }
  });
</script>
{% endblock %}
