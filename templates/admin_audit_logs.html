{% extends "layout.html" %}
{% block content %}
<section class="users-page audit-page">
  <header class="users-toolbar">
    <div class="title-wrap">
      <h1>Audit Logs</h1>
      <p class="subtitle">Review system activity.</p>
    </div>
    <form class="users-search" method="get" id="auditFilters">
      <input name="username" type="search" placeholder="User" value="{{ filters.username or '' }}" style="min-width:0">
      <input name="bar" type="search" placeholder="Bar" value="{{ filters.bar or '' }}" style="min-width:0">
      <select name="action" style="min-width:0">
        <option value="">All actions</option>
        {% for a in actions %}
          <option value="{{ a }}" {% if filters.action == a %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </form>
  </header>
  <div class="table-card">
    <table class="users-table audit-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Credit</th>
          <th>Action</th>
          <th>Entity</th>
          <th>Entity ID</th>
          <th>Bar</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
      {% for entry in logs %}
        <tr>
          <td>{{ entry.log.created_at|format_time }}</td>
          <td>{{ entry.user_name }}</td>
          <td>{{ '%.2f' % entry.log.actor_credit if entry.log.actor_credit is not none else '' }}</td>
          <td>{{ entry.log.action }}</td>
          <td>{{ entry.log.entity_type }}</td>
          <td>{{ entry.log.entity_id or '' }}</td>
          <td>{{ entry.bar_name }}</td>
          <td>{{ entry.payload }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</section>
<script>
(function(){
  const form = document.getElementById('auditFilters');
  if(!form) return;
  form.querySelectorAll('input[type="search"]').forEach(inp=>{
    inp.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        form.submit();
      }
    });
  });
  form.querySelector('select')?.addEventListener('change', ()=>form.submit());
})();
</script>
{% endblock %}
