{% extends "layout.html" %}
{% block content %}
{% set subject_map = subject_translations if subject_translations is defined else {} %}
{% set body_map = body_translations if body_translations is defined else {} %}
<section class="users-page">
  <header class="users-toolbar">
    <div class="title-wrap">
      <h1>{{ _('admin_edit_welcome.title', default='Edit Welcome Message') }}</h1>
    </div>
  </header>
  {% if error %}
  <p class="alert-danger">{{ error }}</p>
  {% endif %}
  <form class="form" method="post" action="/admin/notifications/welcome">
    <div class="field-group translation-control">
      <label for="subject">{{ _('admin_edit_welcome.form.subject', default='Subject') }}
        <input id="subject" type="text" name="subject" value="{{ subject_map.get(language_code, subject) }}" maxlength="30" required>
      </label>
      <button type="button" class="btn-outline translation-toggle" data-translation-target="subjectTranslations" aria-expanded="false">{{ _('admin_edit_welcome.form.subject_translate_button', default='Translate subject') }}</button>
    </div>
    <div id="subjectTranslations" class="translation-panel" hidden>
      <p class="translation-help">{{ _('admin_edit_welcome.form.subject_translation_help', default='Provide a subject for every supported language.') }}</p>
      {% for lang in available_languages %}
      <label for="subject_{{ lang.code }}">{{ _('admin_edit_welcome.form.language_subject_label', language=lang.name, default='{language} subject') }}
        <input id="subject_{{ lang.code }}" name="subject_{{ lang.code }}" value="{{ subject_map.get(lang.code, subject) }}" maxlength="30">
      </label>
      {% endfor %}
    </div>
    <div class="field-group">
      <p class="translation-label">{{ _('admin_edit_welcome.form.message', default='Message') }}</p>
    </div>
    <div id="bodyTranslations" class="translation-panel">
      <p class="translation-help">{{ _('admin_edit_welcome.form.message_translation_help', default='Write the welcome message in each supported language.') }}</p>
      {% set default_lang = (available_languages | selectattr('code', 'equalto', default_language) | list | first) %}
      <p class="translation-note">{{ _('admin_edit_welcome.form.message_default_language_help', language=(default_lang.name if default_lang else default_language|upper), default='Provide the {language} message. Other languages inherit it when no translation is set.') }}</p>
      {% for lang in available_languages %}
      <label for="body_{{ lang.code }}">{{ _('admin_edit_welcome.form.language_message_label', language=lang.name, default='{language} message') }}
        <textarea id="body_{{ lang.code }}" name="body_{{ lang.code }}"{% if lang.code == default_language %} required aria-required="true"{% endif %}>{{ body_map.get(lang.code, body) }}</textarea>
      </label>
      {% endfor %}
    </div>
    <button class="btn btn--primary" type="submit">{{ _('admin_edit_welcome.form.save', default='Save') }}</button>
  </form>
</section>
<style>
.translation-control{display:flex;flex-direction:column;gap:8px;margin-bottom:var(--space-3,12px);}
.translation-control label{flex:1;}
.translation-toggle{align-self:flex-start;margin-top:auto;}
.translation-panel{border:1px dashed rgba(15,23,42,.25);border-radius:12px;padding:16px;margin-bottom:var(--space-3,12px);display:flex;flex-direction:column;gap:12px;}
.translation-panel label{display:flex;flex-direction:column;font-weight:500;gap:6px;}
.translation-panel input,.translation-panel textarea{width:100%;}
.translation-panel textarea{min-height:96px;}
.translation-help{margin:0;font-size:.9rem;opacity:.75;}
.translation-note{margin:0;font-size:.85rem;color:#475569;}
.translation-label{margin:0;font-weight:600;}
@media (min-width:600px){
  .translation-control{flex-direction:row;align-items:flex-end;}
  .translation-control label{flex:1;}
  .translation-toggle{margin-left:16px;}
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.translation-toggle').forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-translation-target');
        const target = targetId ? document.getElementById(targetId) : null;
        if (!target) return;
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        const next = !expanded;
        btn.setAttribute('aria-expanded', String(next));
        if (next) {
          target.removeAttribute('hidden');
        } else {
          target.setAttribute('hidden', '');
        }
      });
    });
  });
</script>
{% endblock %}
