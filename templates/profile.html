{% extends "layout.html" %}
{% block content %}
<section class="profile-page">
  <div class="profile-card">
    <div class="profile-head">
      <h1 class="profile-title">Profile</h1>
      <p class="profile-subtitle">Manage your account, security, and phone number.</p>
    </div>
    {% if error %}<p class="alert">{{ error }}</p>{% endif %}
    <form method="post" action="/profile" id="profile-form" class="profile-form">
      <div class="form-grid">
        <div class="field" data-name="username">
          <label for="username" class="block-label">Username</label>
          <div class="input-with-icon">
            <input id="username" type="text" name="username" required autocomplete="username" inputmode="text" enterkeyhint="next" minlength="3" maxlength="24" pattern="(?![._-])(?!.*[._-]{2})(?!.*[._-]$)[a-z0-9._-]{3,24}" title="3–24 characters, lowercase letters, numbers, dot, hyphen or underscore. No spaces." value="{{ username|default(user.username) }}">
            <button type="button" class="edit-btn icon" aria-label="Edit username"><i class="bi bi-pencil-square"></i></button>
          </div>
        </div>
        <div class="field" data-name="email">
          <label for="email" class="block-label">Email</label>
          <div class="input-with-icon">
            <input id="email" type="email" name="email" required autocomplete="email" inputmode="email" enterkeyhint="next" pattern="[^@]+@[^@]+\.[^@]+" title="Email must be in the format text@text.text" value="{{ email|default(user.email) }}">
            <button type="button" class="edit-btn icon" aria-label="Edit email"><i class="bi bi-pencil-square"></i></button>
          </div>
        </div>
        <div class="field" data-name="current-password">
          <label for="current_password" class="block-label">Current Password</label>
          <div class="password-wrapper input-with-icon">
            <input id="current_password" type="password" name="current_password" autocomplete="current-password" enterkeyhint="next" minlength="8" maxlength="128" title="Password must be between 8 and 128 characters">
            <button type="button" class="toggle-password icon" aria-label="Show password"><i class="bi bi-eye"></i></button>
            <button type="button" class="edit-btn icon" aria-label="Edit current password"><i class="bi bi-pencil-square"></i></button>
          </div>
          <span id="capsWarningCurrent" class="caps-warning" hidden>Caps Lock is on</span>
        </div>
        <div class="field" data-name="new-password">
          <label for="password" class="block-label">New Password</label>
          <div class="password-wrapper input-with-icon">
            <input id="password" type="password" name="password" autocomplete="new-password" enterkeyhint="next" minlength="8" maxlength="128" title="Password must be between 8 and 128 characters">
            <button type="button" class="toggle-password icon" aria-label="Show password"><i class="bi bi-eye"></i></button>
            <button type="button" class="edit-btn icon" aria-label="Edit new password"><i class="bi bi-pencil-square"></i></button>
          </div>
          <span id="capsWarning" class="caps-warning" hidden>Caps Lock is on</span>
          <div class="pw-meter" aria-hidden="true">
            <div class="pw-meter-bar"></div>
          </div>
          <small class="help">Use 8+ characters with letters &amp; numbers.</small>
        </div>
        <div class="field" data-name="confirm-password">
          <label for="confirm_password" class="block-label">Confirm Password</label>
          <div class="password-wrapper input-with-icon">
            <input id="confirm_password" type="password" name="confirm_password" autocomplete="new-password" enterkeyhint="next" minlength="8" maxlength="128" title="Passwords must match">
            <button type="button" class="toggle-password icon" aria-label="Show password"><i class="bi bi-eye"></i></button>
            <button type="button" class="edit-btn icon" aria-label="Edit confirm password"><i class="bi bi-pencil-square"></i></button>
          </div>
          <span id="capsWarningConfirm" class="caps-warning" hidden>Caps Lock is on</span>
        </div>
        <div class="field span-2" data-name="phone">
          <label class="block-label">Phone</label>
          <div class="phone-row">
            <div class="input-with-icon">
              <select id="prefix" name="prefix" required autocomplete="tel-country-code">
                <option value="+41" {% if (prefix|default(user.prefix)) == "+41" %}selected{% endif %}>+41 (Switzerland)</option>
                <option value="+1" {% if (prefix|default(user.prefix)) == "+1" %}selected{% endif %}>+1 (USA)</option>
                <option value="+44" {% if (prefix|default(user.prefix)) == "+44" %}selected{% endif %}>+44 (UK)</option>
              </select>
              <button type="button" class="edit-btn icon" aria-label="Edit phone prefix"><i class="bi bi-pencil-square"></i></button>
            </div>
            <div class="input-with-icon">
              <input id="phone" type="tel" name="phone" required autocomplete="tel-national" inputmode="tel" enterkeyhint="done" pattern="[0-9]{9,10}" minlength="9" maxlength="10" title="Phone number must be 9 to 10 digits" value="{{ phone|default(user.phone) }}">
              <button type="button" class="edit-btn icon" aria-label="Edit phone number"><i class="bi bi-pencil-square"></i></button>
            </div>
          </div>
          <small class="help">Use mobile format for your country.</small>
        </div>
      </div>
      <div class="sticky-actions">
        <button class="btn btn--primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/password.js" defer></script>
<script>
(function(){
  document.querySelectorAll('.field[data-name$="password"] input[type="password"], .field[data-name$="password"] input[type="text"]').forEach(function(inp){
    var wrapper = inp.closest('.input-with-icon') || (function(){
      var w = document.createElement('div'); w.className = 'input-with-icon';
      inp.parentNode.insertBefore(w, inp); w.appendChild(inp); return w;
    }());
    var btn = wrapper.querySelector('.icon');
    if(!btn){
      btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'icon';
      btn.setAttribute('aria-label','Toggle visibility');
      btn.innerHTML = '👁️';
      wrapper.appendChild(btn);
    }
    btn.addEventListener('click', function(){
      inp.type = (inp.type === 'password') ? 'text' : 'password';
    });
  });

  var newPw = document.querySelector('.field[data-name="new-password"] input');
  var bar = document.querySelector('.field[data-name="new-password"] .pw-meter-bar');
  if(newPw && bar){
    newPw.addEventListener('input', function(){
      var v = newPw.value || '';
      var score = 0;
      if(v.length >= 8) score++;
      if(/[A-Z]/.test(v) && /[a-z]/.test(v)) score++;
      if(/\d/.test(v)) score++;
      if(/[^A-Za-z0-9]/.test(v)) score++;
      var pct = [0, 25, 55, 80, 100][score];
      bar.style.width = pct + '%';
    });
  }

  var originalSave = document.querySelector('#profile-form button[type="submit"], #profile-form #save, #profile-form .save');
  var stickySave = document.querySelector('.profile-page .sticky-actions button');
  if(originalSave && stickySave && originalSave !== stickySave){
    stickySave.addEventListener('click', function(e){
      e.preventDefault();
      originalSave.click();
    });
  }
})();
</script>
{% endblock %}
