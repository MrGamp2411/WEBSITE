{% extends "layout.html" %}
{% import "components/bar_components.html" as bc %}
{% block content %}
{% set fallback_img = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjIxJz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+" %}
<section class="bar-detail" data-latitude="{{ bar.latitude }}" data-longitude="{{ bar.longitude }}" data-rating="{{ bar.rating or '' }}" data-rating_count="{{ bar.rating_count or '' }}" data-distance_km="{{ bar.distance_km or '' }}" itemscope itemtype="https://schema.org/BarOrPub">
  <header class="bar-header">
    {{ bc.status_badge(bar.is_open_now) }}
    <h1 class="title" itemprop="name">{{ bar.name }}</h1>
    <div class="bar-actions">
      <button class="icon-btn" aria-label="Save"><i class="bi bi-bookmark"></i></button>
      <button class="icon-btn" aria-label="Share"><i class="bi bi-share"></i></button>
    </div>
  </header>
  <div class="bar-cover">
    {% if bar.photo_url %}
      <img src="{{ bar.photo_url }}" alt="{{ bar.name }} photo" itemprop="image" loading="lazy" decoding="async" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
    {% else %}
      <div class="placeholder"><i class="bi bi-cup"></i></div>
    {% endif %}
  </div>
  {{ bc.meta(bar) }}
  {{ bc.description(bar.description) }}
  {{ bc.opening_hours(opening_hours) }}
  {% if bar.tags %}
    <ul class="chips">
      {% for t in bar.tags %}
      <li class="chip">{{ t }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  {{ bc.photo_strip(bar.photos) }}
</section>
{{ bc.sticky_actions(bar) }}
{% if error %}
<p class="error">{{ error }}</p>
{% endif %}
{% for category, products in products_by_category %}
  <section class="category product-section" id="products">
    <div class="section-head">
      <h2>{{ category.name }}</h2>
      <div class="scroller-nav">
        <button class="scroll-btn prev" aria-label="Previous">‹</button>
        <button class="scroll-btn next" aria-label="Next">›</button>
      </div>
    </div>
    <p>{{ category.description }}</p>
    <ul class="products scroller">
      {% for product in products %}
      <li>
        <article class="product-card">
          <div class="thumb-wrapper">
            <img class="thumb" src="{{ product.photo_url }}" alt="{{ product.name }} photo" itemprop="image" loading="lazy" decoding="async" width="400" height="225" srcset="{{ product.photo_url }} 400w, {{ product.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
          </div>
          <h3 class="title">{{ product.name }}</h3>
          <div class="card-body">
            <p class="desc description">{{ product.description }}</p>
            <p class="price"><strong>CHF {{ '%.2f'|format(product.price) }}</strong></p>
            {% if user %}
            <form class="form form--inline" method="post" action="/bars/{{ bar.id }}/add_to_cart">
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <button class="btn btn--primary btn--small add-to-cart" type="submit">Add to Cart</button>
            </form>
            {% else %}
            <a class="btn add-to-cart" href="/login">Login to order</a>
            {% endif %}
          </div>
        </article>
      </li>
      {% endfor %}
    </ul>
  </section>
{% endfor %}
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="/static/js/bar_detail.min.js" defer></script>
{% endblock %}
