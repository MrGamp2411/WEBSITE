{% extends "layout.html" %}
{% block content %}
{% set fallback_img = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjI1Jz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+" %}
<h1>{{ bar.name }}</h1>
{% if bar.photo_url %}
<img class="thumb" src="{{ bar.photo_url }}" alt="{{ bar.name }} photo" itemprop="image" loading="lazy" decoding="async" width="400" height="225" srcset="{{ bar.photo_url }} 400w, {{ bar.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
{% else %}
<img class="thumb" src="{{ fallback_img }}" alt="" loading="lazy" width="400" height="225">
{% endif %}
<div class="bar-info" data-rating="{{ bar.rating or '' }}" data-latitude="{{ bar.latitude }}" data-longitude="{{ bar.longitude }}">
  <div class="bar-meta">
    <span class="bar-rating" data-has-rating="true" hidden></span>
    <span class="bar-distance" data-has-distance="true" hidden></span>
  </div>
  <p class="desc">{{ bar.description }}</p>
  <address>{{ bar.address }}, {{ bar.city }}{% if bar.state %}, {{ bar.state }}{% endif %}</address>
  {% if bar.is_open_now %}
  <span class="status status-open">Open now</span>
  {% else %}
  <span class="status status-closed">Closed now</span>
  {% endif %}
  {% if bar.opening_hours %}
  <ul class="opening-hours">
    {% set day_names = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}
    {% for i in range(7) %}
      {% set times = bar.opening_hours.get(str(i)) %}
      {% if times %}
      <li>{{ day_names[i] }}: {{ times.open }} - {{ times.close }}</li>
      {% endif %}
    {% endfor %}
  </ul>
  {% endif %}
</div>
{% if error %}
<p class="error">{{ error }}</p>
{% endif %}
{% for category, products in products_by_category %}
  <section class="category product-section">
    <div class="section-head">
      <h2>{{ category.name }}</h2>
      <div class="scroller-nav">
        <button class="scroll-btn prev" aria-label="Previous">‹</button>
        <button class="scroll-btn next" aria-label="Next">›</button>
      </div>
    </div>
    <p>{{ category.description }}</p>
    <ul class="products scroller">
      {% for product in products %}
      <li>
        <article class="product-card">
          <div class="thumb-wrapper">
            <img class="thumb" src="{{ product.photo_url }}" alt="{{ product.name }} photo" itemprop="image" loading="lazy" decoding="async" width="400" height="225" srcset="{{ product.photo_url }} 400w, {{ product.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
          </div>
          <h3 class="title">{{ product.name }}</h3>
          <div class="card-body">
            <p class="desc description">{{ product.description }}</p>
            <p class="price"><strong>CHF {{ '%.2f'|format(product.price) }}</strong></p>
            {% if user %}
            <form class="form form--inline" method="post" action="/bars/{{ bar.id }}/add_to_cart">
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <button class="btn btn--primary btn--small add-to-cart" type="submit">Add to Cart</button>
            </form>
            {% else %}
            <a class="btn add-to-cart" href="/login">Login to order</a>
            {% endif %}
          </div>
        </article>
      </li>
      {% endfor %}
    </ul>
  </section>
{% endfor %}
{% endblock %}
