{% extends "layout.html" %}
{% block content %}
{% set fallback_img = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjI1Jz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+" %}
<h1>{{ bar.name }}</h1>
{% if bar.photo_url %}
<img class="thumb" src="{{ bar.photo_url }}" alt="{{ bar.name }} photo" itemprop="image" loading="lazy" decoding="async" width="400" height="225" srcset="{{ bar.photo_url }} 400w, {{ bar.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
{% else %}
<img class="thumb" src="{{ fallback_img }}" alt="" loading="lazy" width="400" height="225">
{% endif %}
<p>{{ bar.address }}, {{ bar.city }}, {{ bar.state }}</p>
{% if error %}
<p class="error">{{ error }}</p>
{% endif %}
{% for category, products in products_by_category %}
  <section class="category product-section">
    <div class="section-head">
      <h2>{{ category.name }}</h2>
      <div class="scroller-nav">
        <button class="scroll-btn prev" aria-label="Previous">‹</button>
        <button class="scroll-btn next" aria-label="Next">›</button>
      </div>
    </div>
    <p>{{ category.description }}</p>
    {% if category.photo_url %}
    <img src="{{ category.photo_url }}" alt="{{ category.name }} photo" style="max-width:200px;"/>
    {% endif %}
    {% if user and (user.is_super_admin or (user.bar_id == bar.id and (user.is_bar_admin or user.is_bartender))) %}
    <a class="btn btn--small" href="/bar/{{ bar.id }}/categories/{{ category.id }}/edit">Edit Category</a>
    {% endif %}
    <ul class="products scroller">
      {% for product in products %}
      <li>
        <article class="product-card">
          <div class="thumb-wrapper">
            <img class="thumb" src="{{ product.photo_url }}" alt="{{ product.name }} photo" itemprop="image" loading="lazy" decoding="async" width="400" height="225" srcset="{{ product.photo_url }} 400w, {{ product.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
          </div>
          <h3 class="title">{{ product.name }}</h3>
          <p class="desc">{{ product.description }}</p>
          <p><strong>CHF {{ '%.2f'|format(product.price) }}</strong></p>
          {% if user %}
          <form class="form form--inline" method="post" action="/bars/{{ bar.id }}/add_to_cart">
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <button class="btn btn--primary btn--small" type="submit">Add to Cart</button>
          </form>
          {% else %}
          <a class="btn" href="/login">Login to order</a>
          {% endif %}
        </article>
      </li>
      {% endfor %}
    </ul>
  </section>
{% endfor %}
{% endblock %}
