{% extends "layout.html" %}
{% block content %}
{% set fallback_img = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjIxJz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+" %}
<section class="bar-detail" data-latitude="{{ bar.latitude }}" data-longitude="{{ bar.longitude }}" data-rating="{{ bar.rating or '' }}" data-distance_km="{{ bar.distance_km or '' }}" data-ordering-paused="{{ 'true' if bar.ordering_paused else 'false' }}" itemscope itemtype="https://schema.org/BarOrPub">
  <div class="bar-cover-wrapper">
    {% if bar.photo_url %}
    <img class="bar-cover" src="{{ bar.photo_url }}" alt="{{ bar.name }} photo" itemprop="image" loading="lazy" decoding="async" width="400" height="225" srcset="{{ bar.photo_url }} 400w, {{ bar.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" data-fallback-src="{{ fallback_img }}">
    {% else %}
    <img class="bar-cover" src="{{ fallback_img }}" alt="" loading="lazy" width="400" height="225">
    {% endif %}
  </div>
  {% set google_maps_url = None %}
  {% set apple_maps_url = None %}
  {% if bar.latitude and bar.longitude %}
  {% set destination_value = bar.latitude ~ ',' ~ bar.longitude %}
  {% set google_maps_url = 'https://www.google.com/maps/dir/?api=1&destination=' ~ destination_value|urlencode %}
  {% set apple_maps_url = 'https://maps.apple.com/?daddr=' ~ destination_value|urlencode %}
  {% elif bar.address and bar.city %}
    {% if bar.state %}
    {% set destination_value = bar.address ~ ', ' ~ bar.city ~ ', ' ~ bar.state %}
    {% else %}
    {% set destination_value = bar.address ~ ', ' ~ bar.city %}
    {% endif %}
  {% set google_maps_url = 'https://www.google.com/maps/dir/?api=1&destination=' ~ destination_value|urlencode %}
  {% set apple_maps_url = 'https://maps.apple.com/?daddr=' ~ destination_value|urlencode %}
  {% endif %}
  <div class="bar-title-row">
    <h1 class="bar-title" itemprop="name">{{ bar.name }}</h1>
    {% if google_maps_url and apple_maps_url %}
    <a class="cta-pill cta-pill--ghost bar-directions"
      href="{{ google_maps_url }}"
      data-google-url="{{ google_maps_url }}"
      data-apple-url="{{ apple_maps_url }}"
      target="_blank"
      rel="noopener">
      {{ _('bar_detail.get_directions', default='Get directions') }}
    </a>
    {% endif %}
  </div>
  <div class="bar-meta">
    <span class="bar-status">
      <span class="status {% if bar.is_open_now %}status-open{% else %}status-closed{% endif %}">{% if bar.is_open_now %}{{ _('bar_detail.status.open', default='Open now') }}{% else %}{{ _('bar_detail.status.closed', default='Closed now') }}{% endif %}</span>
    </span>
    {% if bar.rating %}<span class="bar-rating"><i class="bi bi-star-fill" aria-hidden="true"></i> {{ '%.1f'|format(bar.rating) }}</span>{% endif %}
    <span class="bar-distance" data-has-distance="true" hidden><i class="bi bi-geo-alt" aria-hidden="true"></i> <span class="distance-value"></span></span>
  </div>
  <p class="bar-address">{{ bar.address }}, {{ bar.city }}{% if bar.state %}, {{ bar.state }}{% endif %}</p>
  <p class="bar-desc clamp" itemprop="description">{{ bar_description(bar) }}</p>
  {% if opening_hours %}
  <section class="bar-hours-card">
    <h2 class="bar-hours-title">{{ _('bar_detail.hours.title', default='Opening hours') }}</h2>
    <div class="hours">
      <div class="hours-col">
        {% for h in opening_hours[:4] %}
        <div class="hour-row">
          <span>{{ _('common.weekdays.' ~ h.day_key, default=h.day) }}</span>
          <span>{% if h.open and h.close %}{{ h.open }} - {{ h.close }}{% else %}{{ _('bar_detail.hours.closed', default='Closed') }}{% endif %}</span>
        </div>
        {% endfor %}
      </div>
      <div class="hours-col">
        {% for h in opening_hours[4:] %}
        <div class="hour-row">
          <span>{{ _('common.weekdays.' ~ h.day_key, default=h.day) }}</span>
          <span>{% if h.open and h.close %}{{ h.open }} - {{ h.close }}{% else %}{{ _('bar_detail.hours.closed', default='Closed') }}{% endif %}</span>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}
</section>
{% if error %}
<p class="error">{{ error }}</p>
{% endif %}
{% for category, products in products_by_category %}
  {% set category_title = category_name(category) %}
  {% set category_summary = category_description(category) %}
  <section class="category product-section">
    <div class="section-head">
      <h2>{{ category_title }}</h2>
      <div class="scroller-nav">
        <button class="scroll-btn prev" aria-label="{{ _('common.previous', default='Previous') }}">‹</button>
        <button class="scroll-btn next" aria-label="{{ _('common.next', default='Next') }}">›</button>
      </div>
    </div>
    <p>{{ category_summary }}</p>
    <ul class="products scroller">
      {% for product in products %}
      {% set display_name = product_name(product) %}
      {% set display_description = product_description(product) %}
      <li>
        <article class="product-card">
          <div class="thumb-wrapper">
            <img class="thumb" src="{{ product.photo_url }}" alt="{{ display_name }} photo" itemprop="image" loading="lazy" decoding="async" width="400" height="225" srcset="{{ product.photo_url }} 400w, {{ product.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" data-fallback-src="{{ fallback_img }}">
          </div>
          <h3 class="title">{{ display_name }}</h3>
          <div class="card-body">
            <p class="desc description">{{ display_description }}</p>
            <p class="price"><strong>CHF {{ '%.2f'|format(product.price) }}</strong></p>
            {% if user %}
            <form class="form form--inline add-to-cart-form" method="post" action="/bars/{{ bar.id }}/add_to_cart">
              <input type="hidden" name="product_id" value="{{ product.id }}">
        <button class="btn btn--primary btn--small add-to-cart" type="submit">{{ _('bar_detail.add_to_cart', default='Add to Cart') }}</button>
        </form>
        {% else %}
        <a class="btn add-to-cart" href="/login">{{ _('bar_detail.login_to_order', default='Login to order') }}</a>
        {% endif %}
          </div>
        </article>
      </li>
      {% endfor %}
    </ul>
  </section>
{% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/static/js/bar-detail.js" defer></script>
{% endblock %}
