{% extends "layout.html" %}
{% block page_styles %}
{{ super() }}
<link rel="stylesheet" href="/static/css/pages/admin-new-notification.css">
{% endblock %}
{% block content %}
{% set subject_map = subject_translations if subject_translations is defined else {} %}
{% set body_map = body_translations if body_translations is defined else {} %}
{% set default_lang = (available_languages | selectattr('code', 'equalto', default_language) | list | first) %}
<section class="users-page">
  <header class="users-toolbar">
    <a class="back-link" href="/admin/notifications"><i class="bi bi-chevron-left" aria-hidden="true"></i> {{ _('admin_new_notification.back', default='Back to notifications') }}</a>
    <div class="title-wrap">
      <h1>{{ _('admin_new_notification.title', default='New Notification') }}</h1>
      <p class="subtitle">{{ _('admin_new_notification.subtitle', default='Send a message to users.') }}</p>
    </div>
  </header>
  {% if error %}
  <p class="alert-danger">{{ error }}</p>
  {% endif %}
  <form id="notificationForm"
        class="form"
        method="post"
        action="/admin/notifications"
        enctype="multipart/form-data"
        data-select-user="{{ _('admin_new_notification.alerts.select_user', default='Please select a user.') }}"
        data-select-bar="{{ _('admin_new_notification.alerts.select_bar', default='Please select a bar.') }}"
        data-select-label="{{ _('admin_new_notification.actions.select', default='Select') }}"
        data-selected-label="{{ _('admin_new_notification.actions.selected', default='Selected') }}">
    <label>{{ _('admin_new_notification.form.target.label', default='Target') }}
      <select name="target" id="target" required>
        <option value="all">{{ _('admin_new_notification.form.target.options.all', default='All Users') }}</option>
        <option value="user">{{ _('admin_new_notification.form.target.options.user', default='Specific User') }}</option>
        <option value="bar">{{ _('admin_new_notification.form.target.options.bar', default='Users of Bar') }}</option>
      </select>
    </label>

    <section id="userSection" hidden>
      <h2>{{ _('admin_new_notification.user_section.title', default='Select User') }}</h2>
      <form class="users-search" role="search" aria-label="{{ _('admin_new_notification.user_section.search.aria', default='Search users') }}">
        <i class="bi bi-search" aria-hidden="true"></i>
        <input id="userSearch" type="search" inputmode="search" autocomplete="off" placeholder="{{ _('admin_new_notification.user_section.search.placeholder', default='Search users…') }}" aria-label="{{ _('admin_new_notification.user_section.search.input_aria', default='Search users') }}">
        <button class="clear" type="button" aria-label="{{ _('admin_new_notification.user_section.search.clear', default='Clear search') }}">
          <i class="bi bi-x-circle" aria-hidden="true"></i>
        </button>
      </form>
      <div class="table-card">
        <table class="users-table">
          <thead>
            <tr>
              <th>{{ _('admin_new_notification.user_section.table.headers.id', default='ID') }}</th>
              <th>{{ _('admin_new_notification.user_section.table.headers.username', default='Username') }}</th>
              <th>{{ _('admin_new_notification.user_section.table.headers.email', default='Email') }}</th>
              <th class="actions">{{ _('admin_new_notification.user_section.table.headers.actions', default='Actions') }}</th>
            </tr>
          </thead>
          <tbody id="userRows">
            {% for u in users %}
            <tr data-name="{{ u.username }} {{ u.email }}">
              <td>{{ u.id }}</td>
              <td>{{ u.username }}</td>
              <td>{{ u.email }}</td>
              <td class="actions">
                <button type="button" class="btn-outline js-pick-user" data-user-id="{{ u.id }}">{{ _('admin_new_notification.actions.select', default='Select') }}</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <input type="hidden" name="user_id" id="user_id">
    </section>

    <section id="barSection" hidden>
      <h2>{{ _('admin_new_notification.bar_section.title', default='Select Bar') }}</h2>
      <form class="bars-search" role="search" aria-label="{{ _('admin_new_notification.bar_section.search.aria', default='Search bars') }}">
        <i class="bi bi-search" aria-hidden="true"></i>
        <input id="barSearch" type="search" inputmode="search" autocomplete="off" placeholder="{{ _('admin_new_notification.bar_section.search.placeholder', default='Search bars…') }}" aria-label="{{ _('admin_new_notification.bar_section.search.input_aria', default='Search bars') }}">
        <button class="clear" type="button" aria-label="{{ _('admin_new_notification.bar_section.search.clear', default='Clear search') }}">
          <i class="bi bi-x-circle" aria-hidden="true"></i>
        </button>
      </form>
      <div class="table-card">
        <table class="bars-table">
          <thead>
            <tr>
              <th>{{ _('admin_new_notification.bar_section.table.headers.id', default='ID') }}</th>
              <th>{{ _('admin_new_notification.bar_section.table.headers.name', default='Name') }}</th>
              <th>{{ _('admin_new_notification.bar_section.table.headers.city', default='City') }}</th>
              <th class="actions">{{ _('admin_new_notification.bar_section.table.headers.actions', default='Actions') }}</th>
            </tr>
          </thead>
          <tbody id="barRows">
            {% for b in bars %}
            <tr data-name="{{ b.name }}">
              <td>{{ "%03d"|format(b.id) }}</td>
              <td>{{ b.name }}</td>
              <td>{{ b.city }}</td>
              <td class="actions">
                <button type="button" class="btn-outline js-pick-bar" data-bar-id="{{ b.id }}">{{ _('admin_new_notification.actions.select', default='Select') }}</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <input type="hidden" name="bar_id" id="bar_id">
    </section>

    <div class="field-group">
      <p class="translation-label">{{ _('admin_new_notification.form.subject', default='Subject') }}</p>
    </div>
    <div class="translation-panel">
      <p class="translation-help">{{ _('admin_new_notification.form.subject_translation_help', default='Provide a subject for every supported language.') }}</p>
      <p class="translation-note">{{ _('admin_new_notification.form.subject_default_language_help', language=(default_lang.name if default_lang else default_language|upper), default='Provide the {language} subject. Other languages inherit it when no translation is set.') }}</p>
      {% for lang in available_languages %}
      <label for="subject_{{ lang.code }}">{{ _('admin_new_notification.form.language_subject_label', language=lang.name, default='{language} subject') }}
        <input id="subject_{{ lang.code }}" name="subject_{{ lang.code }}" maxlength="30" value="{{ subject_map.get(lang.code, '') }}"{% if lang.code == default_language %} required aria-required="true"{% endif %}>
      </label>
      {% endfor %}
    </div>
    <div class="field-group">
      <p class="translation-label">{{ _('admin_new_notification.form.message', default='Message') }}</p>
    </div>
    <div class="translation-panel">
      <p class="translation-help">{{ _('admin_new_notification.form.message_translation_help', default='Write the notification message in each supported language.') }}</p>
      <p class="translation-note">{{ _('admin_new_notification.form.message_default_language_help', language=(default_lang.name if default_lang else default_language|upper), default='Provide the {language} message. Other languages inherit it when no translation is set.') }}</p>
      {% for lang in available_languages %}
      <label for="body_{{ lang.code }}">{{ _('admin_new_notification.form.language_message_label', language=lang.name, default='{language} message') }}
        <textarea id="body_{{ lang.code }}" name="body_{{ lang.code }}" rows="4"{% if lang.code == default_language %} required aria-required="true"{% endif %}>{{ body_map.get(lang.code, '') }}</textarea>
      </label>
      {% endfor %}
    </div>
    <label>{{ _('admin_new_notification.form.link_url', default='Link URL') }}
      <input type="url" name="link_url">
    </label>
    <label>{{ _('admin_new_notification.form.image', default='Image') }}
      <input type="file" name="image" accept="image/*">
    </label>
    <label>{{ _('admin_new_notification.form.attachment', default='Attachment') }}
      <input type="file" name="attachment">
    </label>
    <button class="btn btn--primary" type="submit">{{ _('admin_new_notification.form.submit', default='Send') }}</button>
  </form>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/static/js/admin-new-notification.js" defer></script>
{% endblock %}
