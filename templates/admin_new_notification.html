{% extends "layout.html" %}
{% block content %}
<section class="users-page">
  <header class="users-toolbar">
    <div class="title-wrap">
      <h1>{{ _('admin_new_notification.title', default='New Notification') }}</h1>
      <p class="subtitle">{{ _('admin_new_notification.subtitle', default='Send a message to users.') }}</p>
    </div>
  </header>
  {% if error %}
  <p class="alert-danger">{{ error }}</p>
  {% endif %}
  <form class="form" method="post" action="/admin/notifications" enctype="multipart/form-data">
    <label>{{ _('admin_new_notification.form.target.label', default='Target') }}
      <select name="target" id="target" required>
        <option value="all">{{ _('admin_new_notification.form.target.options.all', default='All Users') }}</option>
        <option value="user">{{ _('admin_new_notification.form.target.options.user', default='Specific User') }}</option>
        <option value="bar">{{ _('admin_new_notification.form.target.options.bar', default='Users of Bar') }}</option>
      </select>
    </label>

    <section id="userSection" hidden>
      <h2>{{ _('admin_new_notification.user_section.title', default='Select User') }}</h2>
      <div class="users-search" role="search" aria-label="{{ _('admin_new_notification.user_section.search.aria', default='Search users') }}" onsubmit="return false">
        <i class="bi bi-search" aria-hidden="true"></i>
        <input id="userSearch" type="search" inputmode="search" autocomplete="off" placeholder="{{ _('admin_new_notification.user_section.search.placeholder', default='Search users…') }}" aria-label="{{ _('admin_new_notification.user_section.search.input_aria', default='Search users') }}">
        <button class="clear" type="button" aria-label="{{ _('admin_new_notification.user_section.search.clear', default='Clear search') }}">
          <i class="bi bi-x-circle" aria-hidden="true"></i>
        </button>
      </div>
      <div class="table-card">
        <table class="users-table">
          <thead>
            <tr>
              <th>{{ _('admin_new_notification.user_section.table.headers.id', default='ID') }}</th>
              <th>{{ _('admin_new_notification.user_section.table.headers.username', default='Username') }}</th>
              <th>{{ _('admin_new_notification.user_section.table.headers.email', default='Email') }}</th>
              <th class="actions">{{ _('admin_new_notification.user_section.table.headers.actions', default='Actions') }}</th>
            </tr>
          </thead>
          <tbody id="userRows">
            {% for u in users %}
            <tr data-name="{{ u.username }} {{ u.email }}">
              <td>{{ u.id }}</td>
              <td>{{ u.username }}</td>
              <td>{{ u.email }}</td>
              <td class="actions">
                <button type="button" class="btn-outline js-pick-user" data-user-id="{{ u.id }}">{{ _('admin_new_notification.actions.select', default='Select') }}</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <input type="hidden" name="user_id" id="user_id">
    </section>

    <section id="barSection" hidden>
      <h2>{{ _('admin_new_notification.bar_section.title', default='Select Bar') }}</h2>
      <div class="bars-search" role="search" aria-label="{{ _('admin_new_notification.bar_section.search.aria', default='Search bars') }}" onsubmit="return false">
        <i class="bi bi-search" aria-hidden="true"></i>
        <input id="barSearch" type="search" inputmode="search" autocomplete="off" placeholder="{{ _('admin_new_notification.bar_section.search.placeholder', default='Search bars…') }}" aria-label="{{ _('admin_new_notification.bar_section.search.input_aria', default='Search bars') }}">
        <button class="clear" type="button" aria-label="{{ _('admin_new_notification.bar_section.search.clear', default='Clear search') }}">
          <i class="bi bi-x-circle" aria-hidden="true"></i>
        </button>
      </div>
      <div class="table-card">
        <table class="bars-table">
          <thead>
            <tr>
              <th>{{ _('admin_new_notification.bar_section.table.headers.id', default='ID') }}</th>
              <th>{{ _('admin_new_notification.bar_section.table.headers.name', default='Name') }}</th>
              <th>{{ _('admin_new_notification.bar_section.table.headers.city', default='City') }}</th>
              <th class="actions">{{ _('admin_new_notification.bar_section.table.headers.actions', default='Actions') }}</th>
            </tr>
          </thead>
          <tbody id="barRows">
            {% for b in bars %}
            <tr data-name="{{ b.name }}">
              <td>{{ "%03d"|format(b.id) }}</td>
              <td>{{ b.name }}</td>
              <td>{{ b.city }}</td>
              <td class="actions">
                <button type="button" class="btn-outline js-pick-bar" data-bar-id="{{ b.id }}">{{ _('admin_new_notification.actions.select', default='Select') }}</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <input type="hidden" name="bar_id" id="bar_id">
    </section>

    <label>{{ _('admin_new_notification.form.subject', default='Subject') }}
      <input type="text" name="subject" maxlength="30">
    </label>
    <label>{{ _('admin_new_notification.form.message', default='Message') }}
      <textarea name="body" rows="4"></textarea>
    </label>
    <label>{{ _('admin_new_notification.form.link_url', default='Link URL') }}
      <input type="url" name="link_url">
    </label>
    <label>{{ _('admin_new_notification.form.image', default='Image') }}
      <input type="file" name="image" accept="image/*">
    </label>
    <label>{{ _('admin_new_notification.form.attachment', default='Attachment') }}
      <input type="file" name="attachment">
    </label>
    <button class="btn btn--primary" type="submit">{{ _('admin_new_notification.form.submit', default='Send') }}</button>
  </form>
</section>

<script>
(function(){
  const target = document.getElementById('target');
  const userSection = document.getElementById('userSection');
  const barSection = document.getElementById('barSection');
  const userInput = document.getElementById('user_id');
  const barInput = document.getElementById('bar_id');
  const form = document.querySelector('form');
  const texts = {{ {
    'select_user': _('admin_new_notification.alerts.select_user', default='Please select a user.'),
    'select_bar': _('admin_new_notification.alerts.select_bar', default='Please select a bar.'),
    'select': _('admin_new_notification.actions.select', default='Select'),
    'selected': _('admin_new_notification.actions.selected', default='Selected')
  }|tojson }};
  function updateTarget(){
    const val = target.value;
    userSection.hidden = val !== 'user';
    barSection.hidden = val !== 'bar';
    userInput.disabled = val !== 'user';
    barInput.disabled = val !== 'bar';
    if(val !== 'user') userInput.value = '';
    if(val !== 'bar') barInput.value = '';
  }
  target.addEventListener('change', updateTarget);
  updateTarget();
  form.addEventListener('submit', e => {
    const val = target.value;
    if((val === 'user' && !userInput.value) || (val === 'bar' && !barInput.value)){
      e.preventDefault();
      alert(val === 'user' ? texts.select_user : texts.select_bar);
    }
  });
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);}}
  function setupSearch(input, tbody){
    if(!input) return;
    const apply = () => {
      const q = norm(input.value);
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const name = tr.dataset.name || '';
        tr.style.display = !q || norm(name).includes(q) ? '' : 'none';
      });
    };
    input.addEventListener('input', debounce(apply,120));
    input.closest('.users-search, .bars-search')?.querySelector('.clear')?.addEventListener('click', () => {
      input.value=''; apply(); input.focus();
    });
  }
  setupSearch(document.getElementById('userSearch'), document.getElementById('userRows'));
  setupSearch(document.getElementById('barSearch'), document.getElementById('barRows'));
  document.getElementById('userRows')?.addEventListener('click', e => {
    const btn = e.target.closest('.js-pick-user');
    if(!btn) return;
    e.preventDefault();
    userInput.value = btn.dataset.userId;
    document.querySelectorAll('.js-pick-user').forEach(b=>b.textContent=texts.select);
    btn.textContent=texts.selected;
  });
  document.getElementById('barRows')?.addEventListener('click', e => {
    const btn = e.target.closest('.js-pick-bar');
    if(!btn) return;
    e.preventDefault();
    barInput.value = btn.dataset.barId;
    document.querySelectorAll('.js-pick-bar').forEach(b=>b.textContent=texts.select);
    btn.textContent=texts.selected;
  });
})();
</script>
{% endblock %}
