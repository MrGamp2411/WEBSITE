{% extends "layout.html" %}
{% block content %}
{% set fallback_img = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjI1Jz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+" %}
<div class="search-page">
  <div class="section-utility container">
    <a class="cta-pill cta-pill--primary" href="/bars" aria-label="Vedi tutti: Bar visitati di recente">
      <span data-i18n="see_all">Vedi tutti</span>
      <i class="bi bi-arrow-right" aria-hidden="true"></i>
    </a>
  </div>
  {% if bars or recent_bars %}
    {% set sections = [
      ('recent', 'Bar visitati di recente'),
      ('nearby', 'I più vicini a te'),
      ('top', 'I più votati'),
      ('popular', 'Consigliati')
    ] %}
    {% for key, title in sections %}
      {% set items =
        recent_bars if key == 'recent' else
        top_bars if key == 'top' else
        recommended_bars if key == 'popular' else
        bars
      %}
      {% if items %}
      <section class="bar-section" data-section="{{ key }}">
        <div class="section-track">
          <div class="section-head">
            <h2>{{ title }}</h2>
            <div class="scroller-nav">
              <button class="scroll-btn prev" aria-label="Precedenti">‹</button>
              <button class="scroll-btn next" aria-label="Successivi">›</button>
            </div>
          </div>
          <div class="cards scroller" aria-label="{{ title }}" tabindex="0">
            {% for bar in items %}
            <a class="bar-card{% if bar.is_open_now %} is-open{% endif %}" href="/bars/{{ bar.id }}" aria-label="Apri {{ bar.name }}" data-name="{{ bar.name|lower }}" data-address="{{ bar.address|lower }}" data-city="{{ bar.city|lower }}" data-state="{{ bar.state|lower }}" data-latitude="{{ bar.latitude }}" data-longitude="{{ bar.longitude }}" data-rating="{{ bar.rating or '' }}" data-distance_km="{{ bar.distance_km or '' }}" data-categories="{{ bar.bar_categories|lower if bar.bar_categories else '' }}" data-open="{{ 'true' if bar.is_open_now else 'false' }}" itemscope itemtype="https://schema.org/BarOrPub">
          {% if bar.photo_url %}
            <div class="thumb-wrapper">
            <img src="{{ bar.photo_url }}" alt="{{ bar.name }} photo" class="thumb" loading="lazy" decoding="async" width="400" height="225" srcset="{{ bar.photo_url }} 400w, {{ bar.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
            </div>
          {% else %}
            <div class="thumb-wrapper">
            <img src="{{ fallback_img }}" alt="" class="thumb" loading="lazy" width="400" height="225">
            </div>
          {% endif %}
          {% if bar.is_open_now %}
          <span class="status status-open">Open now</span>
          {% else %}
          <span class="status status-closed">Closed now</span>
          {% endif %}
            <h3 class="title" itemprop="name">{{ bar.name }}</h3>
            <div class="bar-meta">
              <span class="bar-rating" data-has-rating="true" hidden></span>
              <span class="bar-distance" data-has-distance="true" hidden></span>
            </div>
            {% if bar.city %}<address>{{ bar.city }}{% if bar.state %}, {{ bar.state }}{% endif %}</address>{% endif %}
            {% if bar.description_short or bar.description %}<p class="desc">{{ bar.description_short or bar.description }}</p>{% endif %}
            </a>
            {% endfor %}
          </div>
        </div>
      </section>
      {% elif key == 'top' and top_bars_message %}
      <section class="bar-section" data-section="{{ key }}">
        <div class="section-head">
          <h2>{{ title }}</h2>
        </div>
        <p>{{ top_bars_message }}</p>
      </section>
      {% endif %}
    {% endfor %}
  {% else %}
  <div class="empty-state">
    <p>Nessun bar trovato.</p>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/search.js" defer></script>
{% endblock %}

