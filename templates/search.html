{% extends "layout.html" %}
{% block content %}
{% set fallback_img = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjI1Jz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZWVlJy8+PC9zdmc+" %}
<div class="search-page">
  <div class="search-stick">
    <label class="visually-hidden" for="barSearch">Cerca bar o città</label>
    <input id="barSearch" type="search" placeholder="Cerca un bar o una città…" aria-label="Cerca bar o città" inputmode="search" autocomplete="off">
    <button id="filterBtn" class="filter-btn" aria-label="Filtri">
      <i class="bi bi-sliders"></i>
      <span id="filterCount" class="cart-badge" hidden></span>
    </button>
  </div>
  {% if bars %}
    {% set sections = [
      ('recent', 'Bar visitati di recente'),
      ('nearby', 'I più vicini a te'),
      ('top', 'I più votati'),
      ('popular', 'Consigliati')
    ] %}
    {% for key, title in sections %}
    <section class="bar-section">
      <div class="section-head">
        <h2>{{ title }}</h2>
        <div class="scroller-nav">
          <button class="scroll-btn prev" aria-label="Precedenti">‹</button>
          <button class="scroll-btn next" aria-label="Successivi">›</button>
        </div>
      </div>
      <div class="cards scroller" aria-label="{{ title }}" tabindex="0">
        {% for bar in bars %}
        <a class="bar-card" href="/bars/{{ bar.id }}" aria-label="Apri {{ bar.name }}" data-name="{{ bar.name|lower }}" data-address="{{ bar.address|lower }}" data-city="{{ bar.city|lower }}" data-state="{{ bar.state|lower }}" data-latitude="{{ bar.latitude }}" data-longitude="{{ bar.longitude }}" data-rating="{{ bar.rating or '' }}" data-distance_km="{{ bar.distance_km or '' }}" data-categories="{{ bar.categories.values() | map(attribute='name') | map('lower') | join(',') if bar.categories else '' }}" data-open="{{ 'true' if bar.open_now else 'false' }}" itemscope itemtype="https://schema.org/BarOrPub">
          {% if bar.image_url %}
          <img src="{{ bar.image_url }}" alt="Foto bar" class="thumb" loading="lazy" decoding="async" width="400" height="225" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
          {% else %}
          <img src="{{ fallback_img }}" alt="" class="thumb" loading="lazy" width="400" height="225">
          {% endif %}
          <h3 class="title" itemprop="name">{{ bar.name }}</h3>
          <div class="bar-meta">
            <span class="bar-rating" data-has-rating="true" hidden></span>
            <span class="bar-distance" data-has-distance="true" hidden></span>
          </div>
          {% if bar.address_short or bar.address %}<address>{{ bar.address_short or bar.address }}</address>{% endif %}
          {% if bar.description_short or bar.description %}<p class="desc">{{ bar.description_short or bar.description }}</p>{% endif %}
        </a>
        {% endfor %}
      </div>
    </section>
    {% endfor %}
  {% else %}
  <div class="empty-state">
    <p>Nessun bar trovato.</p>
    <button type="button" id="clearFilters" class="btn btn--secondary">Clear filters</button>
  </div>
  {% endif %}
</div>
  <div id="filterOverlay" class="filter-overlay" hidden>
  <div class="filter-sheet" role="dialog" aria-modal="true" aria-labelledby="filterTitle">
    <div class="grabber" aria-hidden="true"></div>
    <h2 id="filterTitle">Filtri</h2>
    <form id="filterForm">
      <div class="group" data-key="max_km" data-active="false">
        <div class="group-head">
          <label for="filterDistance">Max distance</label>
          <div class="group-toggle">
            <input type="checkbox" id="filterDistanceToggle">
            <span id="filterDistanceVal" class="chip value-chip" hidden></span>
          </div>
        </div>
        <input type="range" id="filterDistance" name="distance" min="1" max="50" step="1" value="50" aria-label="Max distance in kilometers" aria-valuenow="50">
        <span id="filterDistanceAnnounce" class="visually-hidden" aria-live="polite"></span>
        <p class="help inactive-hint">Attiva per filtrare</p>
      </div>
      <div class="group" data-key="min_rating" data-active="false">
        <div class="group-head">
          <label for="filterRating">Min rating</label>
          <div class="group-toggle">
            <input type="checkbox" id="filterRatingToggle">
            <span id="filterRatingVal" class="chip value-chip" hidden></span>
          </div>
        </div>
        <input type="range" id="filterRating" name="rating" min="0" max="5" step="0.1" value="0" aria-label="Minimum rating" aria-valuenow="0">
        <span id="filterRatingAnnounce" class="visually-hidden" aria-live="polite"></span>
        <p class="help inactive-hint">Attiva per filtrare</p>
      </div>
      <div class="group" data-key="categories" data-active="false">
        <div class="group-head">
          <p>Category</p>
          <span id="filterCategoryVal" class="chip value-chip" hidden></span>
        </div>
        {% set cats = namespace(names=[]) %}
        {% for bar in bars %}
          {% for c in bar.categories.values() %}
            {% if c.name not in cats.names %}
              {% set cats.names = cats.names + [c.name] %}
            {% endif %}
          {% endfor %}
        {% endfor %}
        <div id="filterCategoryChips" class="chips">
          <button type="button" class="chip" data-value="">All</button>
          {% for name in cats.names %}
          <button type="button" class="chip" data-value="{{ name|lower }}">{{ name }}</button>
          {% endfor %}
        </div>
        <p class="help inactive-hint">Seleziona per attivare</p>
      </div>
      <div class="group" data-key="open_now" data-active="false">
        <div class="group-head">
          <label for="filterOpen">Open now</label>
          <span id="filterOpenVal" class="chip value-chip" hidden></span>
        </div>
        <input type="checkbox" id="filterOpen" name="open">
        <p class="help inactive-hint">Attiva per filtrare</p>
      </div>
      <div class="sheet-footer">
        <button type="button" class="btn reset">Reset</button>
        <button type="submit" class="btn btn--primary apply" disabled>Apply</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/search.js" defer></script>
{% endblock %}

