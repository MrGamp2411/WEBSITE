{% extends "layout.html" %}
{% block content %}
{% set fallback_img = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjI1Jz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+" %}
<div class="search-page">
  <div class="section-utility container">
    <a class="btn-filter" href="/bars" aria-label="{{ _('search.view_all_recent_aria', default='View all: Recently visited bars') }}">
      <span data-i18n="see_all">{{ _('search.view_all', default='View all') }}</span>
      <i class="bi bi-arrow-right" aria-hidden="true"></i>
    </a>
  </div>
  {% if bars or recent_bars %}
    {% set sections = [
      ('recent', _('search.sections.recent', default='Recently visited bars')),
      ('nearby', _('search.sections.nearby', default='Closest to you')),
      ('top', _('search.sections.top', default='Top rated')),
      ('popular', _('search.sections.popular', default='Recommended'))
    ] %}
    {% for key, title in sections %}
      {% set items =
        recent_bars if key == 'recent' else
        top_bars if key == 'top' else
        recommended_bars if key == 'popular' else
        bars
      %}
      {% if items %}
      <section class="bar-section" data-section="{{ key }}">
        <div class="section-track">
          <div class="section-head">
            <h2>{{ title }}</h2>
            <div class="scroller-nav">
              <button class="scroll-btn prev" aria-label="{{ _('common.previous', default='Previous') }}">‹</button>
              <button class="scroll-btn next" aria-label="{{ _('common.next', default='Next') }}">›</button>
            </div>
          </div>
          <div class="cards scroller" aria-label="{{ title }}" tabindex="0">
            {% for bar in items %}
              <a class="bar-card{% if bar.is_open_now %} is-open{% endif %}" href="/bars/{{ bar.id }}" aria-label="{{ _('home.bar_card.open_label', bar_name=bar.name, default='Open {bar_name}') }}" data-name="{{ bar.name|lower }}" data-address="{{ bar.address|lower }}" data-city="{{ bar.city|lower }}" data-state="{{ bar.state|lower }}" data-latitude="{{ bar.latitude }}" data-longitude="{{ bar.longitude }}" data-rating="{{ bar.rating or '' }}" data-distance_km="{{ bar.distance_km or '' }}" data-categories="{{ bar.bar_categories|lower if bar.bar_categories else '' }}" data-open="{{ 'true' if bar.is_open_now else 'false' }}" itemscope itemtype="https://schema.org/BarOrPub">
          {% if bar.photo_url %}
            <div class="thumb-wrapper">
            <img src="{{ bar.photo_url }}" alt="{{ bar.name }} photo" class="thumb" loading="lazy" decoding="async" width="400" height="225" srcset="{{ bar.photo_url }} 400w, {{ bar.photo_url }} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='{{ fallback_img }}';this.onerror=null;">
            </div>
          {% else %}
            <div class="thumb-wrapper">
            <img src="{{ fallback_img }}" alt="" class="thumb" loading="lazy" width="400" height="225">
            </div>
          {% endif %}
          {% if bar.is_open_now %}
          <span class="status status-open">{{ _('home.bar_card.status_open', default='Open now') }}</span>
          {% else %}
          <span class="status status-closed">{{ _('home.bar_card.status_closed', default='Closed now') }}</span>
          {% endif %}
            <h3 class="title" itemprop="name">{{ bar.name }}</h3>
            <div class="bar-meta">
              <span class="bar-rating" data-has-rating="true" hidden></span>
              <span class="bar-distance" data-has-distance="true" hidden></span>
            </div>
            {% if bar.city %}<address>{{ bar.city }}{% if bar.state %}, {{ bar.state }}{% endif %}</address>{% endif %}
            {% if bar.description_short or bar.description %}<p class="desc">{{ bar.description_short or bar.description }}</p>{% endif %}
            </a>
            {% endfor %}
            {% if key != 'recent' %}
            <a class="bar-card browse-bars-card view-all-card" href="/bars">
              <div class="thumb-wrapper">
                <i class="bi bi-arrow-left" aria-hidden="true"></i>
              </div>
              <span>{{ _('search.view_all', default='View all') }}</span>
            </a>
            {% endif %}
          </div>
        </div>
      </section>
      {% elif key == 'top' and top_bars_message %}
      <section class="bar-section" data-section="{{ key }}">
        <div class="section-head">
          <h2>{{ title }}</h2>
        </div>
        <p>{{ top_bars_message }}</p>
      </section>
      {% endif %}
    {% endfor %}
  {% else %}
  <div class="empty-state">
    <p>{{ _('search.empty', default='No bars found.') }}</p>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/search.js" defer></script>
{% endblock %}

