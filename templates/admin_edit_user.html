{% extends "layout.html" %}
{% block content %}
<h1>Edit User {{ user.username }}</h1>
{% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
<form class="form" method="post" action="/admin/users/edit/{{ user.id }}">
  <label for="username">Username</label>
  <input id="username" name="username" type="text" value="{{ user.username }}" required>

  <a class="btn-outline" href="/admin/users/{{ user.id }}/password">Edit Password</a>

  <label for="email">Email</label>
  <input id="email" name="email" type="email" value="{{ user.email }}" required>

  <label for="prefix">Prefix</label>
  <select id="prefix" name="prefix" autocomplete="tel-country-code">
    <option value="+41" {% if user.prefix == "+41" %}selected{% endif %}>+41 (Switzerland)</option>
    <option value="+39" {% if user.prefix == "+39" %}selected{% endif %}>+39 (Italy)</option>
    <option value="+49" {% if user.prefix == "+49" %}selected{% endif %}>+49 (Germany)</option>
    <option value="+33" {% if user.prefix == "+33" %}selected{% endif %}>+33 (France)</option>
  </select>

  <label for="phone">Phone</label>
  <input id="phone" name="phone" type="tel" value="{{ user.phone }}">

  <label for="role">Role</label>
  {% if current.is_super_admin %}
  <select id="role" name="role">
    <option value="super_admin" {% if user.role=='super_admin' %}selected{% endif %}>Super Admin</option>
    <option value="bar_admin" {% if user.role=='bar_admin' %}selected{% endif %}>Bar Admin</option>
    <option value="bartender" {% if user.role=='bartender' %}selected{% endif %}>Bartender</option>
    <option value="customer" {% if user.role=='customer' %}selected{% endif %}>Customer</option>
  </select>

  <h2>Assigned Bars</h2>
  <div class="toolbar-actions">
    <div class="bars-search" role="search" aria-label="Search assigned bars" onsubmit="return false">
      <i class="bi bi-search" aria-hidden="true"></i>
      <input id="assignedBarSearch" type="search" inputmode="search" autocomplete="off"
             placeholder="Search bars by name…" aria-label="Search assigned bars by name">
      <button class="clear" type="button" aria-label="Clear search">
        <i class="bi bi-x-circle" aria-hidden="true"></i>
      </button>
    </div>
  </div>
  <div class="table-card">
    <table class="bars-table">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th>City</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="assignedBars">
        {% for b in bars if b.id in user.bar_ids %}
        <tr data-name="{{ b.name }}">
          <td>{{ "%03d"|format(b.id) }}</td>
          <td>{{ b.name }}</td>
          <td>{{ b.city }}</td>
          <td class="actions">
            <div class="actions-group">
              <button type="button" class="btn-danger-soft js-remove-bar" data-bar-id="{{ b.id }}">Remove</button>
            </div>
            <input type="checkbox" name="bar_ids" value="{{ b.id }}" checked hidden>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h2>Assign a Bar</h2>
  <div class="toolbar-actions">
    <div class="bars-search" role="search" aria-label="Search available bars" onsubmit="return false">
      <i class="bi bi-search" aria-hidden="true"></i>
      <input id="availableBarSearch" type="search" inputmode="search" autocomplete="off"
             placeholder="Search bars by name…" aria-label="Search available bars by name">
      <button class="clear" type="button" aria-label="Clear search">
        <i class="bi bi-x-circle" aria-hidden="true"></i>
      </button>
    </div>
  </div>
  <div class="table-card">
    <table class="bars-table">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th>City</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="availableBars">
        {% for b in bars if b.id not in user.bar_ids %}
        <tr data-name="{{ b.name }}">
          <td>{{ "%03d"|format(b.id) }}</td>
          <td>{{ b.name }}</td>
          <td>{{ b.city }}</td>
          <td class="actions">
            <div class="actions-group">
              <button type="button" class="btn-outline js-add-bar" data-bar-id="{{ b.id }}">Add</button>
            </div>
            <input type="checkbox" name="bar_ids" value="{{ b.id }}" hidden>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <label for="add_credit">Add Credit</label>
  <input id="add_credit" name="add_credit" type="number" step="0.01" value="0">

  <label for="remove_credit">Remove Credit</label>
  <input id="remove_credit" name="remove_credit" type="number" step="0.01" value="0">
  {% else %}
  <select id="role" name="role">
    <option value="bar_admin" {% if user.role=='bar_admin' %}selected{% endif %}>Bar Admin</option>
    <option value="bartender" {% if user.role=='bartender' %}selected{% endif %}>Bartender</option>
  </select>
  <input type="hidden" name="add_credit" value="0">
  <input type="hidden" name="remove_credit" value="0">
  {% endif %}

  <button class="btn btn--primary" type="submit">Save</button>
</form>

{% if current.is_super_admin %}
<div class="actions-group" style="margin-top:var(--space-3)">
  <button type="button" class="btn-danger-soft js-delete-user" data-user-id="{{ user.id }}">Delete</button>
  <form id="delete-user-{{ user.id }}" method="post" action="{{ request.url_for('delete_user', user_id=user.id) }}" style="display:none;"></form>
</div>
<div id="deleteBlocker" class="cart-blocker" hidden>
  <div class="cart-popup">
    <p>Are you sure you want to delete this user?</p>
    <div class="cart-popup-actions">
      <button type="button" class="btn btn--secondary js-cancel-delete">Cancel</button>
      <button type="button" class="btn btn--primary js-confirm-delete">Delete</button>
    </div>
  </div>
</div>
{% endif %}

<script>
(function(){
  const assignedSearch = document.getElementById('assignedBarSearch');
  const availableSearch = document.getElementById('availableBarSearch');
  const assigned = document.getElementById('assignedBars');
  const available = document.getElementById('availableBars');
  if(!assigned || !available) return;
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms)}}
  function setupSearch(input, tbody){
    if(!input) return ()=>{};
    const apply = () => {
      const q = norm(input.value);
      Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        const name = tr.dataset.name || '';
        tr.style.display = !q || norm(name).includes(q) ? '' : 'none';
      });
    };
    input.addEventListener('input', debounce(apply,120));
    input.closest('.bars-search')?.querySelector('.clear')?.addEventListener('click', () => {
      input.value=''; apply(); input.focus();
    });
    return apply;
  }

  const applyAssigned = setupSearch(assignedSearch, assigned);
  const applyAvailable = setupSearch(availableSearch, available);

  function moveRow(tr, toAssigned){
    const checkbox = tr.querySelector('input[name="bar_ids"]');
    const btn = tr.querySelector('button');
    if(toAssigned){
      checkbox.checked = true;
      btn.textContent = 'Remove';
      btn.classList.remove('btn-outline');
      btn.classList.add('btn-danger-soft','js-remove-bar');
      btn.classList.remove('js-add-bar');
      assigned.appendChild(tr);
    } else {
      checkbox.checked = false;
      btn.textContent = 'Add';
      btn.classList.remove('btn-danger-soft');
      btn.classList.add('btn-outline','js-add-bar');
      btn.classList.remove('js-remove-bar');
      available.appendChild(tr);
    }
    applyAssigned();
    applyAvailable();
  }

  assigned.addEventListener('click', e => {
    const btn = e.target.closest('.js-remove-bar');
    if(!btn) return;
    e.preventDefault();
    moveRow(btn.closest('tr'), false);
  });

  available.addEventListener('click', e => {
    const btn = e.target.closest('.js-add-bar');
    if(!btn) return;
    e.preventDefault();
    moveRow(btn.closest('tr'), true);
  });

  const deleteBtn = document.querySelector('.js-delete-user');
  const blocker = document.getElementById('deleteBlocker');
  const cancelBtn = document.querySelector('.js-cancel-delete');
  const confirmBtn = document.querySelector('.js-confirm-delete');
  const deleteForm = document.getElementById('delete-user-{{ user.id }}');
  deleteBtn?.addEventListener('click', e => {
    e.preventDefault();
    if(blocker) blocker.hidden = false;
  });
  cancelBtn?.addEventListener('click', () => {
    if(blocker) blocker.hidden = true;
  });
  confirmBtn?.addEventListener('click', () => {
    deleteForm?.submit();
  });
})();
</script>
{% endblock %}
