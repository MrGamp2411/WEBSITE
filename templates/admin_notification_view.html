{% extends "layout.html" %}
{% block content %}
<section class="users-page">
  <header class="users-toolbar">
    <div class="title-wrap">
      <h1>Notification {{ note.id }}</h1>
      <p class="subtitle">Details and recipients.</p>
    </div>
    <a href="/admin/notifications" class="btn-outline">Back</a>
  </header>

  <div class="table-card">
    <table class="users-table">
      <tbody>
        <tr>
          <th>Recipient Target</th>
          <td>
            {% if note.target == 'all' %}All Users{% elif note.target == 'user' %}
              {{ note.user.username }} (#{{ note.user_id }})
            {% elif note.target == 'bar' %}
              {{ note.bar.name }} (#{{ "%03d"|format(note.bar_id) }})
            {% endif %}
          </td>
        </tr>
        <tr><th>Subject</th><td>{{ note.subject }}</td></tr>
        <tr><th>Message</th><td>{{ note.body }}</td></tr>
        {% if note.link_url %}<tr><th>Link</th><td><a href="{{ note.link_url }}">{{ note.link_url }}</a></td></tr>{% endif %}
        <tr><th>Sent</th><td>{{ note.created_at|format_time }}</td></tr>
        <tr><th>Sender</th><td>{{ note.sender.username }}</td></tr>
      </tbody>
    </table>
  </div>

  <h2>Recipients</h2>
  <div class="table-card">
    <table class="users-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Read</th>
        </tr>
      </thead>
      <tbody>
        {% for r in recipients %}
        <tr>
          <td>{{ r.user.id }}</td>
          <td>{{ r.user.username }}</td>
          <td>{{ r.user.email }}</td>
          <td>{{ 'Yes' if r.read else 'No' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="actions-group" style="margin-top:var(--space-2);">
    <a href="/admin/notifications" class="btn-outline">Back to list</a>
    <button type="button" class="btn-danger-soft js-delete-note" data-note-id="{{ note.id }}">Delete</button>
  </div>
  <form id="delete-note-{{ note.id }}" method="post" action="/admin/notifications/{{ note.id }}/delete" style="display:none;"></form>
</section>

<div id="deleteBlocker" class="cart-blocker" hidden>
  <div class="cart-popup">
    <p>Are you sure you want to delete this notification?</p>
    <div class="cart-popup-actions">
      <button type="button" class="btn btn--secondary js-cancel-delete">Cancel</button>
      <button type="button" class="btn btn--primary js-confirm-delete">Delete</button>
    </div>
  </div>
</div>

<script>
(function(){
  const blocker = document.getElementById('deleteBlocker');
  const cancelBtn = document.querySelector('.js-cancel-delete');
  const confirmBtn = document.querySelector('.js-confirm-delete');
  let targetForm = null;
  document.querySelector('.js-delete-note')?.addEventListener('click', e => {
    e.preventDefault();
    targetForm = document.getElementById('delete-note-{{ note.id }}');
    if(blocker) blocker.hidden = false;
  });
  cancelBtn?.addEventListener('click', () => {
    if(blocker) blocker.hidden = true;
    targetForm = null;
  });
  confirmBtn?.addEventListener('click', () => {
    if(targetForm) targetForm.submit();
  });
})();
</script>
{% endblock %}

