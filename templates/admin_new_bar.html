{% extends "layout.html" %}
{% block content %}
<h1>{{ _('admin_new_bar.title', default='Create New Bar') }}</h1>
{% if error %}<p class="error">{{ error }}</p>{% endif %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<div id="map" style="height:400px;"></div>

<form class="form" method="post" action="/admin/bars/new" enctype="multipart/form-data">
  <label for="name">{{ _('admin_new_bar.form.name', default='Name') }}
    <input id="name" type="text" name="name" required>
  </label>
  <label for="address">{{ _('admin_new_bar.form.address', default='Address') }}
    <input id="address" type="text" name="address" required>
  </label>
  <label for="city">{{ _('admin_new_bar.form.city', default='City') }}
    <input id="city" type="text" name="city" required>
  </label>
  <label for="state">{{ _('admin_new_bar.form.state', default='State') }}
    <input id="state" type="text" name="state" required>
  </label>
  <label for="description">{{ _('admin_new_bar.form.description', default='Description') }}
    <textarea id="description" name="description" required maxlength="120"></textarea>
  </label>
  <label for="photo">{{ _('admin_new_bar.form.photo', default='Photo') }}
    <input id="photo" type="file" name="photo">
  </label>
    <label for="categories">{{ _('admin_new_bar.form.categories', default='Categories') }}
      <select id="categories" name="categories" multiple>
        {% for c in bar_categories %}
        <option value="{{ c }}"{% if selected_categories and c in selected_categories %} selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </label>
  <label for="manual_closed">
    <input id="manual_closed" name="manual_closed" type="checkbox"> {{ _('admin_new_bar.form.manual_closed', default='Close bar manually') }}
  </label>
  {% set days = [
    _('admin_new_bar.days.monday', default='Monday'),
    _('admin_new_bar.days.tuesday', default='Tuesday'),
    _('admin_new_bar.days.wednesday', default='Wednesday'),
    _('admin_new_bar.days.thursday', default='Thursday'),
    _('admin_new_bar.days.friday', default='Friday'),
    _('admin_new_bar.days.saturday', default='Saturday'),
    _('admin_new_bar.days.sunday', default='Sunday')
  ] %}
  <table class="opening-hours">
    <thead>
      <tr><th>{{ _('admin_new_bar.form.hours.day', default='Day') }}</th><th>{{ _('admin_new_bar.form.hours.open', default='Open') }}</th><th>{{ _('admin_new_bar.form.hours.close', default='Close') }}</th></tr>
    </thead>
    <tbody>
    {% for day in days %}
      {% set idx = loop.index0 %}
      <tr>
        <td>{{ day }}</td>
        <td><input type="time" name="open_{{ idx }}"></td>
        <td><input type="time" name="close_{{ idx }}"></td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <input id="latitude" type="hidden" name="latitude" required>
  <input id="longitude" type="hidden" name="longitude" required>
  <button class="btn btn--primary" type="submit">{{ _('admin_new_bar.form.submit', default='Create Bar') }}</button>
</form>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const initialLat = 45.4642;
    const initialLng = 9.1900;
    const map = L.map('map').setView([initialLat, initialLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    const marker = L.marker([initialLat, initialLng], {draggable:true}).addTo(map);
    function updateInputs(e) {
      const pos = e.target.getLatLng();
      document.getElementById('latitude').value = pos.lat.toFixed(6);
      document.getElementById('longitude').value = pos.lng.toFixed(6);
    }
    marker.on('dragend', updateInputs);
    updateInputs({target: marker});

    const catSelect = document.getElementById('categories');
    catSelect.addEventListener('change', () => {
      const selected = Array.from(catSelect.selectedOptions);
      if (selected.length > 5) {
        selected[selected.length - 1].selected = false;
        alert({{ _('admin_new_bar.alerts.max_categories', default='Select up to 5 categories')|tojson }});
      }
    });
  </script>
  {% endblock %}

