{% extends "layout.html" %}
{% block content %}
<h1>Order History</h1>

<h2>Pending Orders</h2>
<div id="pending-orders" class="order-list">
  {% for order in pending_orders %}
  <article id="user-order-{{ order.id }}" class="order-card card card--{{ order.status|lower }}" role="article" aria-labelledby="order-{{ order.id }}-title" data-status="{{ order.status }}">
    <header class="order-card__header">
      <h3 id="order-{{ order.id }}-title">Order #{{ order.id }}</h3>
      <span class="order-status chip status status-{{ order.status|lower }}" aria-label="Order status: {{ order.status|replace('_', ' ')|title }}">{{ order.status|replace('_', ' ')|title }}</span>
    </header>
    <div class="order-card__divider"></div>
    <section class="order-card__meta">
      <dl class="order-kv">
        <div><dt>Total</dt><dd class="num nowrap">CHF {{ "%.2f"|format(order.total) }}</dd></div>
        {% if order.status == 'CANCELED' and order.refund_amount %}<div><dt>Refunded</dt><dd class="num nowrap">CHF {{ "%.2f"|format(order.refund_amount) }}</dd></div>{% endif %}
        <div><dt>Placed</dt><dd class="num nowrap">{{ order.created_at|format_time }}</dd></div>

        <div><dt>Customer</dt><dd>{{ order.customer_name or 'Unknown' }} <a href="tel:{{ (order.customer_prefix or '')|replace(' ', '') }}{{ (order.customer_phone or '')|replace(' ', '') }}">({{ order.customer_prefix or '' }} {{ order.customer_phone or '' }})</a></dd></div>
        <div><dt>Bar</dt><dd>{{ order.bar_name or '' }}</dd></div>

        <div><dt>Table</dt><dd>{{ order.table_name or '' }}</dd></div>
        <div><dt>Payment</dt><dd>{{ order.payment_method.replace('_', ' ')|title if order.payment_method else '' }}</dd></div>
        {% if order.notes %}<div><dt>Notes</dt><dd>{{ order.notes }}</dd></div>{% endif %}

        {% if order.ready_at %}<div><dt>Prep time</dt><dd class="num">{{ ((order.ready_at - order.created_at).total_seconds() // 60)|int }} min</dd></div>{% endif %}
      </dl>
    </section>
    <div class="order-card__divider"></div>
    <section class="order-card__items">
      <ul class="order-items">
        {% for item in order.items %}
        <li><span class="qty">{{ item.qty }}×</span><span class="name">{{ item.menu_item_name or 'Unknown item' }}</span></li>
        {% endfor %}
      </ul>
      {% if order.status == 'PLACED' %}
      <div class="order-actions">
        <button class="cancel-order" data-order-id="{{ order.id }}" data-status="CANCELED">Cancel</button>
      </div>
      {% endif %}
    </section>
  </article>
  {% else %}
  <p>No pending orders.</p>
  {% endfor %}
</div>

<h2>Completed Orders</h2>
<div id="completed-orders" class="order-list">
  {% for order in completed_orders %}
  <article id="user-order-{{ order.id }}" class="order-card card card--{{ order.status|lower }}" role="article" aria-labelledby="order-{{ order.id }}-title" data-status="{{ order.status }}">
    <header class="order-card__header">
      <h3 id="order-{{ order.id }}-title">Order #{{ order.id }}</h3>
      <span class="order-status chip status status-{{ order.status|lower }}" aria-label="Order status: {{ order.status|replace('_', ' ')|title }}">{{ order.status|replace('_', ' ')|title }}</span>
    </header>
    <div class="order-card__divider"></div>
    <section class="order-card__meta">
      <dl class="order-kv">
        <div><dt>Total</dt><dd class="num nowrap">CHF {{ "%.2f"|format(order.total) }}</dd></div>
        {% if order.status == 'CANCELED' and order.refund_amount %}<div><dt>Refunded</dt><dd class="num nowrap">CHF {{ "%.2f"|format(order.refund_amount) }}</dd></div>{% endif %}
        <div><dt>Placed</dt><dd class="num nowrap">{{ order.created_at|format_time }}</dd></div>

        <div><dt>Customer</dt><dd>{{ order.customer_name or 'Unknown' }} <a href="tel:{{ (order.customer_prefix or '')|replace(' ', '') }}{{ (order.customer_phone or '')|replace(' ', '') }}">({{ order.customer_prefix or '' }} {{ order.customer_phone or '' }})</a></dd></div>
        <div><dt>Bar</dt><dd>{{ order.bar_name or '' }}</dd></div>

        <div><dt>Table</dt><dd>{{ order.table_name or '' }}</dd></div>
        <div><dt>Payment</dt><dd>{{ order.payment_method.replace('_', ' ')|title if order.payment_method else '' }}</dd></div>
        {% if order.notes %}<div><dt>Notes</dt><dd>{{ order.notes }}</dd></div>{% endif %}

        {% if order.ready_at %}<div><dt>Prep time</dt><dd class="num">{{ ((order.ready_at - order.created_at).total_seconds() // 60)|int }} min</dd></div>{% endif %}
      </dl>
    </section>
    <div class="order-card__divider"></div>
    <section class="order-card__items">
      <ul class="order-items">
        {% for item in order.items %}
        <li><span class="qty">{{ item.qty }}×</span><span class="name">{{ item.menu_item_name or 'Unknown item' }}</span></li>
        {% endfor %}
      </ul>
    </section>
  </article>
  {% else %}
  <p>No completed orders.</p>
  {% endfor %}
</div>
<script src="/static/js/orders.js"></script>
<script>
  initUser({{ user.id }});
</script>
{% endblock %}
