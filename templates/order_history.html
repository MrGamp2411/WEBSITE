{% extends "layout.html" %}
{% block content %}
<h1>Order History</h1>

<h2>Pending Orders</h2>
<ul id="pending-orders" class="order-list">
  {% for order in pending_orders %}
  <li id="user-order-{{ order.id }}" class="card card--{{ order.status|lower }}" data-status="{{ order.status }}">
    <div class="card__body">
      <h3 class="card__title">Order #{{ order.id }} - <span class="status status-{{ order.status|lower }}">{{ order.status|replace('_', ' ')|title }}</span></h3>
      <p>Customer: {{ order.customer_name or 'Unknown' }} ({{ order.customer_prefix or '' }} {{ order.customer_phone or '' }})</p>
      <p>Bar: {{ order.bar_name or '' }}</p>
      <p>Table: {{ order.table_name or '' }}</p>
      <p>Payment method: {{ order.payment_method.replace('_', ' ')|title if order.payment_method else '' }}</p>
      {% if order.notes %}<p>Notes: {{ order.notes }}</p>{% endif %}
      <p>Total: CHF {{ "%.2f"|format(order.total) }}</p>
      {% if order.status == 'CANCELED' and order.refund_amount %}<p>Refunded: CHF {{ "%.2f"|format(order.refund_amount) }}</p>{% endif %}
      <p>Ordered at: {{ order.created_at|format_time }}</p>
      {% if order.ready_at %}
      <p>Prep time: {{ ((order.ready_at - order.created_at).total_seconds() // 60)|int }} min</p>
      {% endif %}
      <ul>
        {% for item in order.items %}
        <li>{{ item.qty }}× {{ item.menu_item_name or 'Unknown item' }}</li>
        {% endfor %}
      </ul>
      {% if order.status == 'PLACED' %}
      <div class="order-actions">
        <button class="cancel-order" data-order-id="{{ order.id }}" data-status="CANCELED">Cancel</button>
      </div>
      {% endif %}
    </div>
  </li>
  {% else %}
  <li class="card"><div class="card__body">No pending orders.</div></li>
  {% endfor %}
</ul>

<h2>Completed Orders</h2>
<ul id="completed-orders" class="order-list">
  {% for order in completed_orders %}
  <li id="user-order-{{ order.id }}" class="card card--{{ order.status|lower }}" data-status="{{ order.status }}">
    <div class="card__body">
      <h3 class="card__title">Order #{{ order.id }} - <span class="status status-{{ order.status|lower }}">{{ order.status|replace('_', ' ')|title }}</span></h3>
      <p>Customer: {{ order.customer_name or 'Unknown' }} ({{ order.customer_prefix or '' }} {{ order.customer_phone or '' }})</p>
      <p>Bar: {{ order.bar_name or '' }}</p>
      <p>Table: {{ order.table_name or '' }}</p>
      <p>Payment method: {{ order.payment_method.replace('_', ' ')|title if order.payment_method else '' }}</p>
      {% if order.notes %}<p>Notes: {{ order.notes }}</p>{% endif %}
      <p>Total: CHF {{ "%.2f"|format(order.total) }}</p>
      {% if order.status == 'CANCELED' and order.refund_amount %}<p>Refunded: CHF {{ "%.2f"|format(order.refund_amount) }}</p>{% endif %}
      <p>Ordered at: {{ order.created_at|format_time }}</p>
      {% if order.ready_at %}
      <p>Prep time: {{ ((order.ready_at - order.created_at).total_seconds() // 60)|int }} min</p>
      {% endif %}
      <ul>
        {% for item in order.items %}
        <li>{{ item.qty }}× {{ item.menu_item_name or 'Unknown item' }}</li>
        {% endfor %}
      </ul>
    </div>
  </li>
  {% else %}
  <li class="card"><div class="card__body">No completed orders.</div></li>
  {% endfor %}
</ul>
<script src="/static/js/orders.js"></script>
<script>
  initUser({{ user.id }});
</script>
{% endblock %}
