document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".navbar");if(e){const t=()=>e.classList.toggle("is-scrolled",window.scrollY>8);t(),window.addEventListener("scroll",t,{passive:!0})}const t=document.getElementById("barSearch")||document.getElementById("barSearchDesktop"),n=()=>document.querySelectorAll(".bar-card"),a=document.getElementById("locationInput")||document.getElementById("locationInputDesktop"),s=document.getElementById("searchSuggestions")||document.getElementById("searchSuggestionsDesktop"),o=document.querySelectorAll(".location-selector");o.length&&a&&o.forEach(e=>{e.addEventListener("click",()=>{a.value="",a.focus(),a.dispatchEvent(new Event("input"))})});const r=document.querySelector(".location-pill");if(r&&a){const e=()=>{r.textContent=`ðŸ“ ${a.value}`};e(),["input","change"].forEach(t=>a.addEventListener(t,e)),setTimeout(e,1e3)}function i(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;const t=String(e).replace(",",".").match(/-?\d+(\.\d+)?/);return t?parseFloat(t[0]):null}function c(e,t){const n=i(t.rating),a=null==(s=t.distance_km)?null:"number"==typeof s?s>=1e3?s/1e3:s:i(s);var s;const o=e.querySelector(".bar-rating"),r=e.querySelector(".bar-distance");o&&(null!=n?(o.innerHTML='<i class="bi bi-star-fill" aria-hidden="true"></i> <span class="rating-value">'+n.toFixed(1)+"</span>",o.hidden=!1,o.dataset.hasRating="true"):(o.hidden=!0,o.dataset.hasRating="false")),r&&(null!=a?(r.innerHTML='<i class="bi bi-geo-alt-fill" aria-hidden="true"></i> <span class="distance-value">'+a.toFixed(1)+" km</span>",r.hidden=!1,r.dataset.hasDistance="true"):(r.hidden=!0,r.dataset.hasDistance="false"))}function d(e){if(!s)return;const t=e.trim();if(!t)return s.innerHTML="",void s.classList.remove("show");fetch(`/api/search?q=${encodeURIComponent(t)}`).then(e=>e.json()).then(e=>function(e){if(!s)return;if(!e.length)return s.innerHTML="",void s.classList.remove("show");const t=e.map(e=>`\n      <li data-bar-id="${e.id}">\n        <a class="bar-card" href="/bars/${e.id}" aria-label="Apri ${e.name}">\n          <img class="thumb" src="https://source.unsplash.com/random/400x250?bar,${e.id}" alt="${e.name}" loading="lazy" width="400" height="100">\n          <h3 class="title">${e.name}</h3>\n          <div class="bar-meta">\n            <span class="bar-rating" data-has-rating="true" hidden></span>\n            <span class="bar-distance" data-has-distance="true" hidden></span>\n          </div>\n          <address>${e.address}, ${e.city}, ${e.state}</address>\n          <p class="desc">${e.description}</p>\n        </a>\n      </li>\n    `).join("");s.innerHTML=`<ul class="bars">${t}</ul>`,s.classList.add("show"),s.querySelectorAll(".bar-card").forEach((t,n)=>{c(t,e[n]||{})})}(e.bars.slice(0,5)))}if(n().forEach(e=>c(e,e.dataset)),t){t.addEventListener("focus",()=>{t.classList.add("expanded")});const e=function(e,t=300){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}(()=>{!function(e){const t=e.toLowerCase();n().forEach(e=>{const{name:n="",address:a="",city:s="",state:o=""}=e.dataset;e.style.display=n.includes(t)||a.includes(t)||s.includes(t)||o.includes(t)?"":"none"})}(t.value),d(t.value)},300);t.addEventListener("input",e),t.addEventListener("blur",()=>{setTimeout(()=>{""===t.value.trim()&&t.classList.remove("expanded"),s&&s.classList.remove("show")},100)}),t.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),window.location.href=`/search?q=${encodeURIComponent(t.value)}`)})}s&&s.addEventListener("click",e=>{const t=e.target.closest("li[data-bar-id]");if(t){const e=t.getAttribute("data-bar-id");window.location.href=`/bars/${e}`}});const l=n();function u(e,t){l.forEach(n=>{const a=parseFloat(n.dataset.latitude),s=parseFloat(n.dataset.longitude);if(!isFinite(a)||!isFinite(s))return;const o=function(e,t,n,a){const s=e=>e*Math.PI/180,o=6371,r=s(n-e),i=s(a-t),c=Math.sin(r/2)**2+Math.cos(s(e))*Math.cos(s(n))*Math.sin(i/2)**2,d=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return o*d}(e,t,a,s);n.dataset.distance_km=o,c(n,{rating:n.dataset.rating,distance_km:o})})}function m(e,t,n){u(e,t),a&&(a.value=n||`${e.toFixed(3)}, ${t.toFixed(3)}`),function(e,t){fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}`).then(e=>e.json()).then(n=>{if(a){if(n.address){const{city:e,town:t,village:s,postcode:o}=n.address,r=e||t||s;if(r)return void(a.value=o?`${r} ${o}`:r)}a.value=n.display_name||`${e.toFixed(3)}, ${t.toFixed(3)}`}}).catch(()=>{a&&(a.value=`${e.toFixed(3)}, ${t.toFixed(3)}`)})}(e,t)}if(l.length){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:n}=e.coords;m(t,n)}),a&&a.addEventListener("keydown",e=>{if("Enter"===e.key){const e=a.value.trim();e&&function(e){fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(e)}`).then(e=>e.json()).then(t=>{if(t&&t.length){const{lat:n,lon:a}=t[0];m(parseFloat(n),parseFloat(a),e)}})}(e)}})}const h=document.getElementById("themeToggle");if(h){const e=e=>{document.body.classList.toggle("dark-mode","dark"===e),h.textContent="dark"===e?"â˜€ï¸":"ðŸŒ™",h.setAttribute("aria-label","dark"===e?"Switch to light mode":"Switch to dark mode")};h.addEventListener("click",()=>{const t=document.body.classList.contains("dark-mode")?"light":"dark";e(t),localStorage.setItem("theme",t)});const t=localStorage.getItem("theme")||"light";e(t)}const f=document.querySelectorAll(".js-open-menu"),v=document.getElementById("mobileMenu"),p=document.querySelector(".menu-backdrop");let g,y;function b(){g&&g.setAttribute("aria-expanded","false"),v.classList.remove("open"),p.classList.remove("show"),document.body.style.overflow="",v.hidden=!0,p.hidden=!0,y&&y.focus()}f.forEach(e=>{e.addEventListener("click",()=>{"true"===e.getAttribute("aria-expanded")?b():function(e){g=e,y=document.activeElement,g.setAttribute("aria-expanded","true"),v.hidden=!1,p.hidden=!1,requestAnimationFrame(()=>{v.classList.add("open"),p.classList.add("show")}),document.body.style.overflow="hidden";const t=v.querySelector('[role="menuitem"]');t&&t.focus()}(e)})}),p?.addEventListener("click",b),document.addEventListener("keydown",e=>{"Escape"!==e.key||v.hidden||b()}),v?.addEventListener("click",e=>{e.target.closest('[role="menuitem"]')&&b()}),v?.addEventListener("keydown",e=>{if("Tab"!==e.key)return;const t=v.querySelectorAll('[role="menuitem"]');if(!t.length)return;const n=t[0],a=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),a.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),n.focus())}),document.querySelector(".js-open-search")?.addEventListener("click",()=>{const e=document.querySelector(".search-overlay");e?.classList.add("open"),e?.removeAttribute("hidden")}),document.querySelector(".overlay-close")?.addEventListener("click",()=>{const e=document.querySelector(".search-overlay");e?.classList.remove("open"),e?.setAttribute("hidden","")}),document.querySelectorAll(".bar-section").forEach(e=>{const t=e.querySelector(".scroller"),n=e.querySelector(".scroll-btn.prev"),a=e.querySelector(".scroll-btn.next");if(!t)return;const s=()=>{const e=t.querySelector(".bar-card");if(!e)return 0;const n=getComputedStyle(e);return e.offsetWidth+parseFloat(n.marginRight)+parseFloat(n.marginLeft)};let o=s();const r=e=>t.scrollBy({left:e*o,behavior:"smooth"});n?.addEventListener("click",()=>r(-1)),a?.addEventListener("click",()=>r(1)),window.addEventListener("resize",()=>{o=s()}),t.addEventListener("keydown",e=>{"ArrowRight"===e.key&&(e.preventDefault(),r(1)),"ArrowLeft"===e.key&&(e.preventDefault(),r(-1))})})});