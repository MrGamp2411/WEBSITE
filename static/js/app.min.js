document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".navbar");if(e){const t=()=>e.classList.toggle("is-scrolled",window.scrollY>8);t(),window.addEventListener("scroll",t,{passive:!0})}const t=document.getElementById("barSearch")||document.getElementById("barSearchDesktop"),n=()=>document.querySelectorAll(".bar-card"),o=document.getElementById("locationInput")||document.getElementById("locationInputDesktop"),a=document.getElementById("searchSuggestions")||document.getElementById("searchSuggestionsDesktop"),s=document.querySelectorAll(".location-selector");s.length&&o&&s.forEach(e=>{e.addEventListener("click",()=>{o.value="",o.focus(),o.dispatchEvent(new Event("input"))})});const i=document.querySelector(".location-pill");if(i&&o){const e=()=>{i.textContent=`📍 ${o.value}`};e(),["input","change"].forEach(t=>o.addEventListener(t,e)),setTimeout(e,1e3)}function c(e){if(!a)return;const t=e.trim();if(!t)return a.innerHTML="",void a.classList.remove("show");fetch(`/api/search?q=${encodeURIComponent(t)}`).then(e=>e.json()).then(e=>function(e){if(!a)return;if(!e.length)return a.innerHTML="",void a.classList.remove("show");const t=e.map(e=>`\n      <li data-bar-id="${e.id}">\n        <a class="bar-card" href="/bars/${e.id}" aria-label="Apri ${e.name}">\n          <img class="thumb" src="https://source.unsplash.com/random/400x250?bar,${e.id}" alt="${e.name}" loading="lazy" width="400" height="100">\n          <h3 class="title">${e.name}</h3>\n          <div class="meta">\n            <span class="rating"><i class="bi bi-star-fill"></i> ${e.rating||""}</span>\n            <span class="distance"><i class="bi bi-geo-alt-fill"></i> <span class="distance-text"></span></span>\n          </div>\n          <address>${e.address}, ${e.city}, ${e.state}</address>\n          <p class="desc">${e.description}</p>\n        </a>\n      </li>\n    `).join("");a.innerHTML=`<ul class="bars">${t}</ul>`,a.classList.add("show")}(e.bars.slice(0,5)))}if(t){t.addEventListener("focus",()=>{t.classList.add("expanded")});const e=function(e,t=300){let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}}(()=>{!function(e){const t=e.toLowerCase();n().forEach(e=>{const{name:n="",address:o="",city:a="",state:s=""}=e.dataset;e.style.display=n.includes(t)||o.includes(t)||a.includes(t)||s.includes(t)?"":"none"})}(t.value),c(t.value)},300);t.addEventListener("input",e),t.addEventListener("blur",()=>{setTimeout(()=>{""===t.value.trim()&&t.classList.remove("expanded"),a&&a.classList.remove("show")},100)}),t.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),window.location.href=`/search?q=${encodeURIComponent(t.value)}`)})}a&&a.addEventListener("click",e=>{const t=e.target.closest("li[data-bar-id]");if(t){const e=t.getAttribute("data-bar-id");window.location.href=`/bars/${e}`}});const r=n();function l(e,t){r.forEach(n=>{const o=parseFloat(n.dataset.latitude),a=parseFloat(n.dataset.longitude);if(!isFinite(o)||!isFinite(a))return;const s=function(e,t,n,o){const a=e=>e*Math.PI/180,s=6371,i=a(n-e),c=a(o-t),r=Math.sin(i/2)**2+Math.cos(a(e))*Math.cos(a(n))*Math.sin(c/2)**2,l=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r));return s*l}(e,t,o,a);n.dataset.distance=s;const i=n.querySelector(".distance-text");i&&(i.textContent=`${s.toFixed(1)} km`)})}function d(e,t,n){l(e,t),o&&(o.value=n||`${e.toFixed(3)}, ${t.toFixed(3)}`),function(e,t){fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}`).then(e=>e.json()).then(n=>{if(o){if(n.address){const{city:e,town:t,village:a,postcode:s}=n.address,i=e||t||a;if(i)return void(o.value=s?`${i} ${s}`:i)}o.value=n.display_name||`${e.toFixed(3)}, ${t.toFixed(3)}`}}).catch(()=>{o&&(o.value=`${e.toFixed(3)}, ${t.toFixed(3)}`)})}(e,t)}if(r.length){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:n}=e.coords;d(t,n)}),o&&o.addEventListener("keydown",e=>{if("Enter"===e.key){const e=o.value.trim();e&&function(e){fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(e)}`).then(e=>e.json()).then(t=>{if(t&&t.length){const{lat:n,lon:o}=t[0];d(parseFloat(n),parseFloat(o),e)}})}(e)}})}const u=document.getElementById("themeToggle");if(u){const e=e=>{document.body.classList.toggle("dark-mode","dark"===e),u.textContent="dark"===e?"☀️":"🌙",u.setAttribute("aria-label","dark"===e?"Switch to light mode":"Switch to dark mode")};u.addEventListener("click",()=>{const t=document.body.classList.contains("dark-mode")?"light":"dark";e(t),localStorage.setItem("theme",t)});const t=localStorage.getItem("theme")||"light";e(t)}const m=document.querySelectorAll(".js-open-menu"),h=document.getElementById("mobileMenu"),v=document.querySelector(".menu-backdrop");let f,y;function g(){f&&f.setAttribute("aria-expanded","false"),h.classList.remove("open"),v.classList.remove("show"),document.body.style.overflow="",h.hidden=!0,v.hidden=!0,y&&y.focus()}m.forEach(e=>{e.addEventListener("click",()=>{"true"===e.getAttribute("aria-expanded")?g():function(e){f=e,y=document.activeElement,f.setAttribute("aria-expanded","true"),h.hidden=!1,v.hidden=!1,requestAnimationFrame(()=>{h.classList.add("open"),v.classList.add("show")}),document.body.style.overflow="hidden";const t=h.querySelector('[role="menuitem"]');t&&t.focus()}(e)})}),v?.addEventListener("click",g),document.addEventListener("keydown",e=>{"Escape"!==e.key||h.hidden||g()}),h?.addEventListener("click",e=>{e.target.closest('[role="menuitem"]')&&g()}),h?.addEventListener("keydown",e=>{if("Tab"!==e.key)return;const t=h.querySelectorAll('[role="menuitem"]');if(!t.length)return;const n=t[0],o=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),o.focus()):e.shiftKey||document.activeElement!==o||(e.preventDefault(),n.focus())}),document.querySelector(".js-open-search")?.addEventListener("click",()=>{const e=document.querySelector(".search-overlay");e?.classList.add("open"),e?.removeAttribute("hidden")}),document.querySelector(".overlay-close")?.addEventListener("click",()=>{const e=document.querySelector(".search-overlay");e?.classList.remove("open"),e?.setAttribute("hidden","")}),document.querySelectorAll(".bar-section").forEach(e=>{const t=e.querySelector(".scroller"),n=e.querySelector(".scroll-btn.prev"),o=e.querySelector(".scroll-btn.next");if(!t)return;const a=()=>{const e=t.querySelector(".bar-card");if(!e)return 0;const n=getComputedStyle(e);return e.offsetWidth+parseFloat(n.marginRight)+parseFloat(n.marginLeft)};let s=a();const i=e=>t.scrollBy({left:e*s,behavior:"smooth"});n?.addEventListener("click",()=>i(-1)),o?.addEventListener("click",()=>i(1)),window.addEventListener("resize",()=>{s=a()}),t.addEventListener("keydown",e=>{"ArrowRight"===e.key&&(e.preventDefault(),i(1)),"ArrowLeft"===e.key&&(e.preventDefault(),i(-1))})});const p=document.getElementById("filterBtn"),E=document.getElementById("filterOverlay"),L=document.getElementById("filterForm"),k=E?.querySelector(".apply"),b=E?.querySelector(".reset"),w=document.getElementById("filterDistanceVal"),S=document.getElementById("filterRatingVal"),q=document.getElementById("filterCategoryChips"),$=document.getElementById("filterCategory");let I;function x(){E.classList.remove("show"),document.body.style.overflow="",E.hidden=!0,I&&I.focus()}function A(){if(!L||!k)return;let e=!1;Array.from(L.elements).forEach(t=>{"checkbox"===t.type?t.checked!==t.defaultChecked&&(e=!0):t.value!==t.defaultValue&&(e=!0)}),k.disabled=!e}p?.addEventListener("click",function(){I=document.activeElement,E.hidden=!1,requestAnimationFrame(()=>E.classList.add("show")),document.body.style.overflow="hidden";const e=E.querySelector("input,button");e&&e.focus()}),E?.addEventListener("click",e=>{e.target===E&&x()}),document.addEventListener("keydown",e=>{"Escape"!==e.key||E.hidden||x()}),E?.addEventListener("keydown",e=>{if("Tab"!==e.key)return;const t=E.querySelectorAll("input,button");if(!t.length)return;const n=t[0],o=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),o.focus()):e.shiftKey||document.activeElement!==o||(e.preventDefault(),n.focus())}),L?.addEventListener("input",e=>{"filterDistance"===e.target.id&&(w.textContent=`${e.target.value} km`),"filterRating"===e.target.id&&(S.textContent=`≥ ${e.target.value}`),A()}),q?.addEventListener("click",e=>{const t=e.target.closest(".chip");t&&(q.querySelectorAll(".chip").forEach(e=>e.classList.remove("active")),t.classList.add("active"),$.value=t.dataset.value,A())}),b?.addEventListener("click",()=>{L.reset(),q?.querySelectorAll(".chip").forEach(e=>e.classList.remove("active")),q?.querySelector('[data-value=""]').classList.add("active"),w.textContent=`${document.getElementById("filterDistance").value} km`,S.textContent=`≥ ${document.getElementById("filterRating").value}`,A()}),document.getElementById("clearFilters")?.addEventListener("click",()=>{L?.reset(),q?.querySelectorAll(".chip").forEach(e=>e.classList.remove("active")),q?.querySelector('[data-value=""]').classList.add("active"),w.textContent=`${document.getElementById("filterDistance").value} km`,S.textContent=`≥ ${document.getElementById("filterRating").value}`,A()}),A()});