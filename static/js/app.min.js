document.addEventListener("DOMContentLoaded",function(){const e=window.APP_I18N||{},t=e.notices||{},n=e.app||{},o=document.querySelector('meta[name="csrf-token"]'),a=o?o.getAttribute("content"):null;function r(e){if(!e)return!0;try{return new URL(e,window.location.href).origin===window.location.origin}catch(e){return!0}}if(a){window.CSRF_TOKEN=a;const e=e=>{if(!e||"true"===e.dataset.skipCsrf)return;if("GET"===(e.getAttribute("method")||"GET").toUpperCase())return;let t=e.querySelector('input[name="csrf_token"]');t||(t=document.createElement("input"),t.type="hidden",t.name="csrf_token",e.appendChild(t)),t.value=a};if(document.querySelectorAll("form").forEach(e),window.MutationObserver){const t=new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{t instanceof HTMLElement&&("FORM"===t.tagName&&e(t),t.querySelectorAll?.("form").forEach(e))})})});document.body&&t.observe(document.body,{childList:!0,subtree:!0})}if("function"==typeof window.fetch){const e=window.fetch;window.fetch=function(t,n){let o=null,i=null;if(t instanceof Request?(o=t,i=o.url):"string"==typeof t?i=t:t&&"object"==typeof t&&(i=t.url),!r(i))return e.call(this,t,n);const s=n?{...n}:{};let c;return c=o?new Headers(o.headers||{}):s.headers?new Headers(s.headers):new Headers,c.has("X-CSRF-Token")||c.set("X-CSRF-Token",a),s.headers=c,o?e.call(this,new Request(o,s)):e.call(this,t,s)}}if(window.XMLHttpRequest){const e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,n,o,a,r){return this.__csrfUrl=n,e.call(this,t,n,o,a,r)},XMLHttpRequest.prototype.send=function(e){if(r(this.__csrfUrl))try{this.setRequestHeader("X-CSRF-Token",a)}catch(e){}return t.call(this,e)}}}const i="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjI1Jz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+",s=document.querySelector(".site-header");if(s){const e=()=>s.classList.toggle("is-scrolled",window.scrollY>8);e(),window.addEventListener("scroll",e,{passive:!0})}const c=document.getElementById("barSearch")||document.getElementById("barSearchDesktop"),d=()=>document.querySelectorAll(".bar-card, .bar-detail"),l=document.getElementById("locationInput")||document.getElementById("locationInputDesktop"),u=document.getElementById("searchSuggestions")||document.getElementById("searchSuggestionsDesktop"),m=document.querySelectorAll(".location-selector"),p=document.getElementById("servicePaused"),f=document.querySelector(".js-close-service-paused");function h(){p&&(p.hidden=!1)}f&&f.addEventListener("click",()=>{p&&(p.hidden=!0)}),window.orderingPaused&&window.showServicePausedOnLoad&&h();const y=new URLSearchParams(window.location.search),v=y.get("notice");if(["topup_failed","payment_failed","wallet_insufficient"].includes(v)){const e=t.payment_failed||{},n=t[v]||e,o="Payment failed",a="Payment was not successful. Please try again or contact our staff if the problem persists.",r=y.get("noticeTitle")||n.title||e.title||o,i=y.get("noticeBody")||n.body||e.body||a,s=n.close||e.close||"Close",c=document.createElement("div");c.className="cart-blocker";const d=document.createElement("div");d.className="cart-popup",d.innerHTML=`<p><strong>${r}</strong></p><p>${i}</p><div class="cart-popup-actions"><button type="button" class="btn btn--primary notice-close">${s}</button></div>`,c.appendChild(d),document.body.appendChild(c),c.querySelector(".notice-close").addEventListener("click",()=>c.remove());const l=new URL(window.location.href);["notice","noticeTitle","noticeBody","noticeType"].forEach(e=>l.searchParams.delete(e)),window.history.replaceState({},document.title,l.toString())}m.length&&l&&m.forEach(e=>{e.addEventListener("click",()=>{l.value="",l.focus(),l.dispatchEvent(new Event("input"))})});const b=document.querySelector(".location-pill");if(b&&l){const e=()=>{b.textContent=`ðŸ“ ${l.value}`};e(),["input","change"].forEach(t=>l.addEventListener(t,e)),setTimeout(e,1e3)}function g(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;const t=String(e).replace(",",".").match(/-?\d+(\.\d+)?/);return t?parseFloat(t[0]):null}function w(e,t){const n=g(t.rating),o=null==(a=t.distance_km)?null:"number"==typeof a?a>=1e3?a/1e3:a:g(a);var a;const r=e.querySelector(".bar-rating"),i=e.querySelector(".bar-distance");r&&(null!=n?(r.innerHTML='<i class="bi bi-star-fill" aria-hidden="true"></i> <span class="rating-value">'+n.toFixed(1)+"</span>",r.hidden=!1,r.dataset.hasRating="true"):(r.hidden=!0,r.dataset.hasRating="false")),i&&(null!=o?(i.innerHTML='<i class="bi bi-geo-alt-fill" aria-hidden="true"></i> <span class="distance-value">'+o.toFixed(1)+" km</span>",i.hidden=!1,i.dataset.hasDistance="true"):(i.hidden=!0,i.dataset.hasDistance="false"))}function E(e){if(!u)return;if(!e.length)return u.innerHTML="",void u.classList.remove("show");const t=e.map(e=>{return`\n      <li data-bar-id="${e.id}">\n        <a class="bar-card" href="/bars/${e.id}" aria-label="${t=n.open_label,o={bar:e.name},("string"!=typeof t?"":t.replace(/\{(\w+)\}/g,(e,t)=>Object.prototype.hasOwnProperty.call(o,t)?o[t]:""))||`Open ${e.name}`}">\n          <div class="thumb-wrapper"><img class="thumb" src="${e.photo_url||i}" alt="${e.name} photo" loading="lazy" decoding="async" width="400" height="225" srcset="${e.photo_url||i} 400w, ${e.photo_url||i} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='${i}';this.onerror=null;"></div>\n          <h3 class="title">${e.name}</h3>\n          <div class="bar-meta">\n            <span class="bar-rating" data-has-rating="true" hidden></span>\n            <span class="bar-distance" data-has-distance="true" hidden></span>\n          </div>\n          <address>${e.address}, ${e.city}, ${e.state}</address>\n          <p class="desc">${e.description}</p>\n        </a>\n      </li>\n    `;var t,o}).join("");u.innerHTML=`<ul class="bars">${t}</ul>`,u.classList.add("show"),u.querySelectorAll(".bar-card").forEach((t,n)=>{w(t,e[n]||{})})}if(d().forEach(e=>w(e,e.dataset)),c){c.addEventListener("focus",()=>{c.classList.add("expanded")});const e=function(e,t=300){let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}}(()=>{!function(e){const t=e.toLowerCase();d().forEach(e=>{const{name:n="",address:o="",city:a="",state:r=""}=e.dataset;e.style.display=n.includes(t)||o.includes(t)||a.includes(t)||r.includes(t)?"":"none"})}(c.value),function(e){if(!u)return;const t=e.trim();if(!t)return u.innerHTML="",void u.classList.remove("show");fetch(`/api/search?q=${encodeURIComponent(t)}`).then(e=>e.json()).then(e=>E(e.bars.slice(0,5)))}(c.value)},300);c.addEventListener("input",e),c.addEventListener("blur",()=>{setTimeout(()=>{""===c.value.trim()&&c.classList.remove("expanded"),u&&u.classList.remove("show")},100)}),c.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),window.location.href=`/search?q=${encodeURIComponent(c.value)}`)})}u&&u.addEventListener("click",e=>{const t=e.target.closest("li[data-bar-id]");if(t){const e=t.getAttribute("data-bar-id");window.location.href=`/bars/${e}`}});const L=d();function q(){const e=document.getElementById("barList");if(!e)return;const t=Array.from(e.children),n=e.querySelector(".browse-bars-card")?.closest("li"),o=n?t.filter(e=>e!==n):t;o.sort((e,t)=>parseFloat(e.querySelector(".bar-card").dataset.distance_km||"Infinity")-parseFloat(t.querySelector(".bar-card").dataset.distance_km||"Infinity")),o.forEach(t=>e.appendChild(t)),n&&e.appendChild(n),e.scrollLeft=0}function S(){const e=document.getElementById("barList");if(!e)return;const t=Array.from(e.children);let n=0,o=!1;t.forEach(e=>{const t=e.querySelector(".bar-card").dataset.open;if(void 0===t)return void(e.hidden=!1);"true"===t&&n<5?(e.hidden=!1,n++,o=!0):e.hidden=!0});const a=document.getElementById("noBarsMessage");a&&(a.hidden=o)}function k(e,t){L.forEach(n=>{const o=parseFloat(n.dataset.latitude),a=parseFloat(n.dataset.longitude);if(!isFinite(o)||!isFinite(a))return;const r=function(e,t,n,o){const a=e=>e*Math.PI/180,r=6371,i=a(n-e),s=a(o-t),c=Math.sin(i/2)**2+Math.cos(a(e))*Math.cos(a(n))*Math.sin(s/2)**2,d=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return r*d}(e,t,o,a);n.dataset.distance_km=r,w(n,{rating:n.dataset.rating,distance_km:r})}),q(),S()}function A(e,t,n){k(e,t),l&&(l.value=n||`${e.toFixed(3)}, ${t.toFixed(3)}`),function(e,t){l&&fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}`).then(e=>e.json()).then(n=>{if(n.address){const{city:e,town:t,village:o,postcode:a}=n.address,r=e||t||o;if(r)return void(l.value=a?`${r} ${a}`:r)}l.value=n.display_name||`${e.toFixed(3)}, ${t.toFixed(3)}`}).catch(()=>{l&&(l.value=`${e.toFixed(3)}, ${t.toFixed(3)}`)})}(e,t)}if(L.length){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:n}=e.coords;A(t,n)}),q(),S(),l&&l.addEventListener("keydown",e=>{if("Enter"===e.key){const e=l.value.trim();e&&function(e){fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(e)}`).then(e=>e.json()).then(t=>{if(t&&t.length){const{lat:n,lon:o}=t[0];A(parseFloat(n),parseFloat(o),e)}})}(e)}})}const C=document.querySelectorAll(".js-open-menu"),M=document.getElementById("mobileMenu");let $;function F(){if($&&document.body.contains($))return $;$=null;for(const e of document.querySelectorAll(".menu-backdrop"))if(!e.classList.contains("language-backdrop")){$=e;break}return!$&&M&&($=document.createElement("div"),$.className="menu-backdrop",$.hidden=!0,M.insertAdjacentElement("afterend",$)),$}F();const T=M?.querySelector(".js-close-menu"),j=document.querySelectorAll("main, footer");let _,x;const R=e=>{"Escape"===e.key&&I()};function I(){const e=F();M&&e&&(_&&_.setAttribute("aria-expanded","false"),M.classList.remove("is-open"),e.classList.remove("is-open"),document.body.style.overflow="",M.hidden=!0,e.hidden=!0,j.forEach(e=>e.removeAttribute("aria-hidden")),document.removeEventListener("keydown",R),e.removeEventListener("click",I),T?.removeEventListener("click",I),x&&x.focus())}C.forEach(e=>{e.addEventListener("click",()=>{"true"===e.getAttribute("aria-expanded")?I():function(e){const t=F();if(!M||!t)return;_=e,x=document.activeElement,_.setAttribute("aria-expanded","true"),M.hidden=!1,t.hidden=!1,requestAnimationFrame(()=>{M.classList.add("is-open"),t.classList.add("is-open")}),document.body.style.overflow="hidden",j.forEach(e=>e.setAttribute("aria-hidden","true")),document.addEventListener("keydown",R),t.addEventListener("click",I),T?.addEventListener("click",I);const n=M.querySelector('[role="menuitem"]');n&&n.focus()}(e)})}),M?.addEventListener("click",e=>{const t=e.target.closest('[role="menuitem"]');t&&!t.hasAttribute("data-keep-menu-open")&&I()}),M?.addEventListener("keydown",e=>{if("Tab"!==e.key)return;const t=M.querySelectorAll('[role="menuitem"], .js-close-menu');if(!t.length)return;const n=t[0],o=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),o.focus()):e.shiftKey||document.activeElement!==o||(e.preventDefault(),n.focus())});const P=document.getElementById("languageDialog"),D=document.querySelector(".language-backdrop"),H=document.querySelector(".js-open-language"),B=P?.querySelector(".js-close-language"),N=P?.querySelectorAll(".language-option");let O;const U=e=>{if(!P||P.hidden)return;if("Escape"===e.key)return e.preventDefault(),void z();if("Tab"!==e.key)return;const t=P.querySelectorAll(".language-dialog__close, .language-option");if(!t.length)return;const n=t[0],o=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),o.focus()):e.shiftKey||document.activeElement!==o||(e.preventDefault(),n.focus())};function z(){P&&D&&(P.classList.remove("is-open"),D.classList.remove("is-open"),setTimeout(()=>{P.hidden=!0,D.hidden=!0},220),M?.classList.contains("is-open")||(document.body.style.overflow="",j.forEach(e=>e.removeAttribute("aria-hidden"))),document.removeEventListener("keydown",U),D.removeEventListener("click",z),B?.removeEventListener("click",z),O&&O.focus())}function X(e){const t=document.querySelector(".cart-badge");t&&"number"==typeof e.count&&(t.textContent=e.count);const n=document.querySelector(".mini-cart-total");n&&e.totalFormatted&&(n.textContent=e.totalFormatted);const o=document.querySelector(".mini-cart-items");o&&Array.isArray(e.items)&&(o.innerHTML=e.items.map(e=>`<li>${e.qty}Ã— ${e.name} - ${e.lineTotal}</li>`).join(""))}function J(e,t){const n=e.querySelector('input[name="product_id"]'),o=document.createElement("div");o.className="qty-controls",o.innerHTML=`<button type="button" class="btn btn--primary btn--small qty-minus" aria-label="Decrease quantity">-</button><span class="qty-display">${t}</span><button type="button" class="btn btn--primary btn--small qty-plus" aria-label="Increase quantity">+</button>`,e.innerHTML="",n&&e.append(n),e.append(o)}H?.addEventListener("click",e=>{e.preventDefault(),I(),function(){if(!P||!D)return;O=document.activeElement,P.hidden=!1,D.hidden=!1,requestAnimationFrame(()=>{P.classList.add("is-open"),D.classList.add("is-open")}),document.body.style.overflow="hidden",j.forEach(e=>e.setAttribute("aria-hidden","true")),document.addEventListener("keydown",U),D.removeEventListener("click",z),D.addEventListener("click",z),B&&(B.removeEventListener("click",z),B.addEventListener("click",z));const e=P.querySelector('.language-option[aria-checked="true"]')||P.querySelector(".language-option");e?.focus()}()}),N?.forEach(e=>{e.addEventListener("click",()=>{!function(e){if(!e)return;const t=new URL(window.location.href);t.searchParams.set("lang",e),window.location.href=t.toString()}(e.getAttribute("data-lang"))})}),document.querySelectorAll(".bar-section,.product-section").forEach(e=>{const t=e.querySelector(".scroller"),n=e.querySelector(".scroll-btn.prev"),o=e.querySelector(".scroll-btn.next");if(!t)return;const a=()=>{const e=t.querySelector("li:not([hidden]) .bar-card,li:not([hidden]) .product-card");if(!e)return 0;const n=getComputedStyle(e);return e.offsetWidth+parseFloat(n.marginRight)+parseFloat(n.marginLeft)};let r=a();const i=e=>t.scrollBy({left:e*r,behavior:"smooth"});n?.addEventListener("click",()=>i(-1)),o?.addEventListener("click",()=>i(1)),window.addEventListener("resize",()=>{r=a()}),t.addEventListener("keydown",e=>{"ArrowRight"===e.key&&(e.preventDefault(),i(1)),"ArrowLeft"===e.key&&(e.preventDefault(),i(-1))})}),async function(){const e=document.querySelectorAll(".add-to-cart-form");if(e.length)try{const t=await fetch("/cart",{headers:{Accept:"application/json"}});if(!t.ok)return;const n=await t.json();X(n),e.forEach(e=>{const t=e.querySelector('input[name="product_id"]')?.value,o=n.items?.find(e=>e.id===Number(t));o&&J(e,o.qty)})}catch(e){console.error("Cart fetch failed",e)}}(),document.addEventListener("submit",async e=>{if(!e.target.matches(".add-to-cart-form"))return;const t=e.target;if(e.preventDefault(),window.orderingPaused)return void h();const n=t.querySelector('button[type="submit"]');if(n?.disabled)return;const o=new URLSearchParams(new FormData(t));n.disabled=!0;const a=n.textContent;n.textContent="Addingâ€¦";try{const e=await fetch(t.action,{method:"POST",body:body=o,headers:{Accept:"application/json"}});if(409===e.status)return window.orderingPaused=!0,void h();if(!e.ok)throw new Error;const n=await e.json();X(n);const a=o.get("product_id"),r=n.items?.find(e=>e.id===Number(a));J(t,r?r.qty:1)}catch(e){alert("Failed to add to cart")}finally{n.disabled=!1,n.textContent=a}}),document.addEventListener("click",async e=>{const t=e.target.closest(".qty-plus,.qty-minus");if(!t)return;const n=t.closest(".add-to-cart-form");if(!n)return;e.preventDefault();const o=n.querySelector('input[name="product_id"]'),a=n.querySelector(".qty-display");if(!o||!a)return;let r=parseInt(a.textContent,10)||0;if(t.matches(".qty-plus")&&window.orderingPaused)h();else{t.disabled=!0;try{if(t.matches(".qty-plus")){const e=new URLSearchParams({product_id:o.value}),t=await fetch(n.action,{method:"POST",body:e,headers:{Accept:"application/json"}});if(409===t.status)return window.orderingPaused=!0,void h();if(!t.ok)throw new Error;const i=await t.json();X(i);const s=i.items?.find(e=>e.id===Number(o.value));r=s?s.qty:r+1,a.textContent=r}else{r-=1;const e=new URLSearchParams({product_id:o.value,quantity:r}),t=await fetch("/cart/update",{method:"POST",body:e,headers:{Accept:"application/json"}});if(!t.ok)throw new Error;if(X(await t.json()),r<=0){n.innerHTML="",n.append(o);const e=document.createElement("button");e.className="btn btn--primary btn--small add-to-cart",e.type="submit",e.textContent="Add to Cart",n.append(e)}else a.textContent=r}}catch(e){alert("Cart update failed")}finally{t.disabled=!1}}});const Z=document.querySelector(".js-clear-cart");Z&&Z.addEventListener("click",async()=>{Z.disabled=!0;try{await fetch("/cart/clear",{method:"POST",headers:{Accept:"application/json"}}),location.reload()}catch(e){alert("Failed to clear cart"),Z.disabled=!1}})});