document.addEventListener("DOMContentLoaded",function(){const e="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA0MDAgMjI1Jz48cmVjdCB3aWR0aD0nNDAwJyBoZWlnaHQ9JzIyNScgZmlsbD0nJTIzZjFmM2Y1Jy8+PC9zdmc+",t=document.querySelector(".site-header");if(t){const e=()=>t.classList.toggle("is-scrolled",window.scrollY>8);e(),window.addEventListener("scroll",e,{passive:!0})}const n=document.getElementById("barSearch")||document.getElementById("barSearchDesktop"),a=()=>document.querySelectorAll(".bar-card, .bar-detail"),o=document.getElementById("locationInput")||document.getElementById("locationInputDesktop"),r=document.getElementById("searchSuggestions")||document.getElementById("searchSuggestionsDesktop"),s=document.querySelectorAll(".location-selector"),i=document.getElementById("servicePaused"),c=document.querySelector(".js-close-service-paused");function d(){i&&(i.hidden=!1)}c&&c.addEventListener("click",()=>{i&&(i.hidden=!0)}),window.orderingPaused&&window.showServicePausedOnLoad&&d(),s.length&&o&&s.forEach(e=>{e.addEventListener("click",()=>{o.value="",o.focus(),o.dispatchEvent(new Event("input"))})});const l=document.querySelector(".location-pill");if(l&&o){const e=()=>{l.textContent=`ðŸ“ ${o.value}`};e(),["input","change"].forEach(t=>o.addEventListener(t,e)),setTimeout(e,1e3)}function u(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;const t=String(e).replace(",",".").match(/-?\d+(\.\d+)?/);return t?parseFloat(t[0]):null}function m(e,t){const n=u(t.rating),a=null==(o=t.distance_km)?null:"number"==typeof o?o>=1e3?o/1e3:o:u(o);var o;const r=e.querySelector(".bar-rating"),s=e.querySelector(".bar-distance");r&&(null!=n?(r.innerHTML='<i class="bi bi-star-fill" aria-hidden="true"></i> <span class="rating-value">'+n.toFixed(1)+"</span>",r.hidden=!1,r.dataset.hasRating="true"):(r.hidden=!0,r.dataset.hasRating="false")),s&&(null!=a?(s.innerHTML='<i class="bi bi-geo-alt-fill" aria-hidden="true"></i> <span class="distance-value">'+a.toFixed(1)+" km</span>",s.hidden=!1,s.dataset.hasDistance="true"):(s.hidden=!0,s.dataset.hasDistance="false"))}function h(t){if(!r)return;const n=t.trim();if(!n)return r.innerHTML="",void r.classList.remove("show");fetch(`/api/search?q=${encodeURIComponent(n)}`).then(e=>e.json()).then(t=>function(t){if(!r)return;if(!t.length)return r.innerHTML="",void r.classList.remove("show");const n=t.map(t=>`\n      <li data-bar-id="${t.id}">\n        <a class="bar-card" href="/bars/${t.id}" aria-label="Open ${t.name}">\n          <div class="thumb-wrapper"><img class="thumb" src="${t.photo_url||e}" alt="${t.name} photo" loading="lazy" decoding="async" width="400" height="225" srcset="${t.photo_url||e} 400w, ${t.photo_url||e} 800w" sizes="(max-width: 600px) 100vw, 400px" onerror="this.src='${e}';this.onerror=null;"></div>\n          <h3 class="title">${t.name}</h3>\n          <div class="bar-meta">\n            <span class="bar-rating" data-has-rating="true" hidden></span>\n            <span class="bar-distance" data-has-distance="true" hidden></span>\n          </div>\n          <address>${t.address}, ${t.city}, ${t.state}</address>\n          <p class="desc">${t.description}</p>\n        </a>\n      </li>\n    `).join("");r.innerHTML=`<ul class="bars">${n}</ul>`,r.classList.add("show"),r.querySelectorAll(".bar-card").forEach((e,n)=>{m(e,t[n]||{})})}(t.bars.slice(0,5)))}if(a().forEach(e=>m(e,e.dataset)),n){n.addEventListener("focus",()=>{n.classList.add("expanded")});const e=function(e,t=300){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}(()=>{!function(e){const t=e.toLowerCase();a().forEach(e=>{const{name:n="",address:a="",city:o="",state:r=""}=e.dataset;e.style.display=n.includes(t)||a.includes(t)||o.includes(t)||r.includes(t)?"":"none"})}(n.value),h(n.value)},300);n.addEventListener("input",e),n.addEventListener("blur",()=>{setTimeout(()=>{""===n.value.trim()&&n.classList.remove("expanded"),r&&r.classList.remove("show")},100)}),n.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),window.location.href=`/search?q=${encodeURIComponent(n.value)}`)})}r&&r.addEventListener("click",e=>{const t=e.target.closest("li[data-bar-id]");if(t){const e=t.getAttribute("data-bar-id");window.location.href=`/bars/${e}`}});const p=a();function y(){const e=document.getElementById("barList");if(!e)return;const t=Array.from(e.children),n=e.querySelector(".browse-bars-card")?.closest("li"),a=n?t.filter(e=>e!==n):t;a.sort((e,t)=>parseFloat(e.querySelector(".bar-card").dataset.distance_km||"Infinity")-parseFloat(t.querySelector(".bar-card").dataset.distance_km||"Infinity")),a.forEach(t=>e.appendChild(t)),n&&e.appendChild(n),e.scrollLeft=0}function f(){const e=document.getElementById("barList");if(!e)return;const t=Array.from(e.children);let n=0,a=!1;t.forEach(e=>{const t=e.querySelector(".bar-card").dataset.open;if(void 0===t)return void(e.hidden=!1);"true"===t&&n<5?(e.hidden=!1,n++,a=!0):e.hidden=!0});const o=document.getElementById("noBarsMessage");o&&(o.hidden=a)}function v(e,t){p.forEach(n=>{const a=parseFloat(n.dataset.latitude),o=parseFloat(n.dataset.longitude);if(!isFinite(a)||!isFinite(o))return;const r=function(e,t,n,a){const o=e=>e*Math.PI/180,r=6371,s=o(n-e),i=o(a-t),c=Math.sin(s/2)**2+Math.cos(o(e))*Math.cos(o(n))*Math.sin(i/2)**2,d=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return r*d}(e,t,a,o);n.dataset.distance_km=r,m(n,{rating:n.dataset.rating,distance_km:r})}),y(),f()}function b(e,t,n){v(e,t),o&&(o.value=n||`${e.toFixed(3)}, ${t.toFixed(3)}`),function(e,t){fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}`).then(e=>e.json()).then(n=>{if(o){if(n.address){const{city:e,town:t,village:a,postcode:r}=n.address,s=e||t||a;if(s)return void(o.value=r?`${s} ${r}`:s)}o.value=n.display_name||`${e.toFixed(3)}, ${t.toFixed(3)}`}}).catch(()=>{o&&(o.value=`${e.toFixed(3)}, ${t.toFixed(3)}`)})}(e,t)}if(p.length){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:n}=e.coords;b(t,n)}),y(),f(),o&&o.addEventListener("keydown",e=>{if("Enter"===e.key){const e=o.value.trim();e&&function(e){fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(e)}`).then(e=>e.json()).then(t=>{if(t&&t.length){const{lat:n,lon:a}=t[0];b(parseFloat(n),parseFloat(a),e)}})}(e)}})}const g=document.getElementById("themeToggle");if(g){const e=e=>{document.body.classList.toggle("dark-mode","dark"===e),g.textContent="dark"===e?"â˜€ï¸":"ðŸŒ™",g.setAttribute("aria-label","dark"===e?"Switch to light mode":"Switch to dark mode")};g.addEventListener("click",()=>{const t=document.body.classList.contains("dark-mode")?"light":"dark";e(t),localStorage.setItem("theme",t)});const t=localStorage.getItem("theme")||"light";e(t)}const w=document.querySelectorAll(".js-open-menu"),E=document.getElementById("mobileMenu"),L=document.querySelector(".menu-backdrop"),q=E?.querySelector(".js-close-menu"),S=document.querySelectorAll("main, .hdr-sub, footer");let k,A;const $=e=>{"Escape"===e.key&&x()};function x(){k&&k.setAttribute("aria-expanded","false"),E.classList.remove("is-open"),L.classList.remove("is-open"),document.body.style.overflow="",E.hidden=!0,L.hidden=!0,S.forEach(e=>e.removeAttribute("aria-hidden")),document.removeEventListener("keydown",$),L.removeEventListener("click",x),q?.removeEventListener("click",x),A&&A.focus()}function C(e){const t=document.querySelector(".cart-badge");t&&"number"==typeof e.count&&(t.textContent=e.count);const n=document.querySelector(".mini-cart-total");n&&e.totalFormatted&&(n.textContent=e.totalFormatted);const a=document.querySelector(".mini-cart-items");a&&Array.isArray(e.items)&&(a.innerHTML=e.items.map(e=>`<li>${e.qty}Ã— ${e.name} - ${e.lineTotal}</li>`).join(""))}function I(e,t){const n=e.querySelector('input[name="product_id"]'),a=document.createElement("div");a.className="qty-controls",a.innerHTML=`<button type="button" class="btn btn--primary btn--small qty-minus" aria-label="Decrease quantity">-</button><span class="qty-display">${t}</span><button type="button" class="btn btn--primary btn--small qty-plus" aria-label="Increase quantity">+</button>`,e.innerHTML="",n&&e.append(n),e.append(a)}w.forEach(e=>{e.addEventListener("click",()=>{"true"===e.getAttribute("aria-expanded")?x():function(e){k=e,A=document.activeElement,k.setAttribute("aria-expanded","true"),E.hidden=!1,L.hidden=!1,requestAnimationFrame(()=>{E.classList.add("is-open"),L.classList.add("is-open")}),document.body.style.overflow="hidden",S.forEach(e=>e.setAttribute("aria-hidden","true")),document.addEventListener("keydown",$),L.addEventListener("click",x),q?.addEventListener("click",x);const t=E.querySelector('[role="menuitem"]');t&&t.focus()}(e)})}),E?.addEventListener("click",e=>{e.target.closest('[role="menuitem"]')&&x()}),E?.addEventListener("keydown",e=>{if("Tab"!==e.key)return;const t=E.querySelectorAll('[role="menuitem"], .js-close-menu');if(!t.length)return;const n=t[0],a=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),a.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),n.focus())}),document.querySelector(".js-open-search")?.addEventListener("click",()=>{const e=document.querySelector(".search-overlay");e?.classList.add("open"),e?.removeAttribute("hidden")}),document.querySelector(".overlay-close")?.addEventListener("click",()=>{const e=document.querySelector(".search-overlay");e?.classList.remove("open"),e?.setAttribute("hidden","")}),document.querySelectorAll(".bar-section,.product-section").forEach(e=>{const t=e.querySelector(".scroller"),n=e.querySelector(".scroll-btn.prev"),a=e.querySelector(".scroll-btn.next");if(!t)return;const o=()=>{const e=t.querySelector("li:not([hidden]) .bar-card,li:not([hidden]) .product-card");if(!e)return 0;const n=getComputedStyle(e);return e.offsetWidth+parseFloat(n.marginRight)+parseFloat(n.marginLeft)};let r=o();const s=e=>t.scrollBy({left:e*r,behavior:"smooth"});n?.addEventListener("click",()=>s(-1)),a?.addEventListener("click",()=>s(1)),window.addEventListener("resize",()=>{r=o()}),t.addEventListener("keydown",e=>{"ArrowRight"===e.key&&(e.preventDefault(),s(1)),"ArrowLeft"===e.key&&(e.preventDefault(),s(-1))})}),async function(){const e=document.querySelectorAll(".add-to-cart-form");if(e.length)try{const t=await fetch("/cart",{headers:{Accept:"application/json"}});if(!t.ok)return;const n=await t.json();C(n),e.forEach(e=>{const t=e.querySelector('input[name="product_id"]')?.value,a=n.items?.find(e=>e.id===Number(t));a&&I(e,a.qty)})}catch(e){console.error("Cart fetch failed",e)}}(),document.addEventListener("submit",async e=>{if(!e.target.matches(".add-to-cart-form"))return;const t=e.target;if(e.preventDefault(),window.orderingPaused)return void d();const n=t.querySelector('button[type="submit"]');if(n?.disabled)return;const a=new URLSearchParams(new FormData(t));n.disabled=!0;const o=n.textContent;n.textContent="Addingâ€¦";try{const e=await fetch(t.action,{method:"POST",body:body=a,headers:{Accept:"application/json"}});if(409===e.status)return window.orderingPaused=!0,void d();if(!e.ok)throw new Error;const n=await e.json();C(n);const o=a.get("product_id"),r=n.items?.find(e=>e.id===Number(o));I(t,r?r.qty:1)}catch(e){alert("Failed to add to cart")}finally{n.disabled=!1,n.textContent=o}}),document.addEventListener("click",async e=>{const t=e.target.closest(".qty-plus,.qty-minus");if(!t)return;const n=t.closest(".add-to-cart-form");if(!n)return;e.preventDefault();const a=n.querySelector('input[name="product_id"]'),o=n.querySelector(".qty-display");if(!a||!o)return;let r=parseInt(o.textContent,10)||0;if(t.matches(".qty-plus")&&window.orderingPaused)d();else{t.disabled=!0;try{if(t.matches(".qty-plus")){const e=new URLSearchParams({product_id:a.value}),t=await fetch(n.action,{method:"POST",body:e,headers:{Accept:"application/json"}});if(409===t.status)return window.orderingPaused=!0,void d();if(!t.ok)throw new Error;const s=await t.json();C(s);const i=s.items?.find(e=>e.id===Number(a.value));r=i?i.qty:r+1,o.textContent=r}else{r-=1;const e=new URLSearchParams({product_id:a.value,quantity:r}),t=await fetch("/cart/update",{method:"POST",body:e,headers:{Accept:"application/json"}});if(!t.ok)throw new Error;if(C(await t.json()),r<=0){n.innerHTML="",n.append(a);const e=document.createElement("button");e.className="btn btn--primary btn--small add-to-cart",e.type="submit",e.textContent="Add to Cart",n.append(e)}else o.textContent=r}}catch(e){alert("Cart update failed")}finally{t.disabled=!1}}});const F=document.querySelector(".js-clear-cart");F&&F.addEventListener("click",async()=>{F.disabled=!0;try{await fetch("/cart/clear",{method:"POST",headers:{Accept:"application/json"}}),location.reload()}catch(e){alert("Failed to clear cart"),F.disabled=!1}})});